<div class="dashboard-container">
  <!-- Header con logo -->
  <header class="dashboard-header">
    <div class="logo-container">
      <div class="logo-background">
        <img src="assets/imagenes/Logo-Retina-Movil.png" alt="Logo" class="logo">
      </div>
    </div>
    <div class="header-title">
      <h1>Panel de Mando</h1>
      <p>Sistema de Análisis de Indicadores de Hemodiálisis</p>
    </div>
  </header>

  <!-- Cards principales de configuración -->
  <div class="config-section">
    <div class="section-title">
      <mat-icon>settings</mat-icon>
      <span class="title-text">Configuración del Análisis</span>
    </div>
    
    <div class="config-grid">
      <!-- Card de fechas - doble ancho -->
      <mat-card class="config-card date-card large-card">
        <mat-card-header>
          <mat-card-title>Rango de Fechas</mat-card-title>
          <mat-card-subtitle>Selecciona el período de análisis</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="date-inputs">
            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Fecha inicio</mat-label>
              <input matInput [matDatepicker]="startPicker" [value]="startDate" (dateChange)="onStartDateChange($event.value)">
              <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Fecha fin</mat-label>
              <input matInput [matDatepicker]="endPicker" [value]="endDate" (dateChange)="onEndDateChange($event.value)">
              <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <button mat-raised-button color="warn" class="reset-btn" (click)="resetDates()">
            <span class="button-text">Reiniciar Todo</span>
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Cards laterales apiladas -->
      <div class="side-cards">
        <!-- Card de bases de datos -->
        <mat-card class="config-card database-card">
          <mat-card-header>
            <mat-card-title>Bases de Datos</mat-card-title>
            <mat-card-subtitle>{{sel.getDatabases().length}} bases seleccionadas</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="selection-info">
              <div class="info-item" *ngIf="sel.getDatabases().length > 0">
                <mat-icon>check_circle</mat-icon>
                <span>{{sel.getDatabases().length}} base(s) de datos configurada(s)</span>
              </div>
              <div class="info-item warning" *ngIf="sel.getDatabases().length === 0">
                <mat-icon>warning</mat-icon>
                <span>No hay bases de datos seleccionadas</span>
              </div>
            </div>
          </mat-card-content>
          <mat-card-actions>
            <button mat-raised-button color="primary" class="config-btn" (click)="goToBases()">
              <span class="button-text">Elegir Bases de Datos</span>
            </button>
          </mat-card-actions>
        </mat-card>

        <!-- Card de indicadores -->
        <mat-card class="config-card indicators-card">
          <mat-card-header>
            <mat-card-title>Indicadores</mat-card-title>
            <mat-card-subtitle>{{sel.getIndicators().length}} indicadores seleccionados</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="selection-info">
              <div class="info-item" *ngIf="sel.getIndicators().length > 0">
                <mat-icon>check_circle</mat-icon>
                <span>{{sel.getIndicators().length}} indicador(es) configurado(s)</span>
              </div>
              <div class="info-item warning" *ngIf="sel.getIndicators().length === 0">
                <mat-icon>warning</mat-icon>
                <span>No hay indicadores seleccionados</span>
              </div>
            </div>
          </mat-card-content>
          <mat-card-actions>
            <button mat-raised-button color="primary" class="config-btn" (click)="goToIndicadores()">
              <span class="button-text">Elegir Indicadores</span>
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>
  </div>

  <!-- Sección de análisis -->
  <div class="analysis-section">
    <div class="section-title">
      <mat-icon>play_circle_filled</mat-icon>
      <span class="title-text">Ejecutar Análisis</span>
    </div>

    <mat-card class="analysis-card">
      <mat-card-content>
        <div class="analysis-content">
          <div class="analysis-info">
            <h3>¿Listo para analizar?</h3>
            <p>Asegúrate de haber configurado las fechas, seleccionado las bases de datos e indicadores antes de continuar.</p>
            
            <div class="readiness-check">
              <div class="check-item" [class.ready]="startDate && endDate">
                <mat-icon>{{startDate && endDate ? 'check_circle' : 'radio_button_unchecked'}}</mat-icon>
                <span>Rango de fechas definido</span>
              </div>
              <div class="check-item" [class.ready]="sel.getDatabases().length > 0">
                <mat-icon>{{sel.getDatabases().length > 0 ? 'check_circle' : 'radio_button_unchecked'}}</mat-icon>
                <span>Bases de datos seleccionadas</span>
              </div>
              <div class="check-item" [class.ready]="sel.getIndicators().length > 0">
                <mat-icon>{{sel.getIndicators().length > 0 ? 'check_circle' : 'radio_button_unchecked'}}</mat-icon>
                <span>Indicadores seleccionados</span>
              </div>
            </div>
          </div>
          
          <div class="analysis-action">
            <button 
              mat-raised-button 
              color="accent" 
              class="analyze-btn"
              [disabled]="!readyToSendFront || loading"
              (click)="sendToBack()">
              <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
              <span class="button-text" *ngIf="!loading">Iniciar Análisis</span>
              <span class="button-text" *ngIf="loading">Procesando...</span>
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Sección de resultados -->
  <div class="results-section" *ngIf="apiResponse && apiResponse.success">
    <div class="section-title">
      <mat-icon>assessment</mat-icon>
      <span class="title-text">Resultados del Análisis</span>
    </div>

    <!-- Resumen general -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>Resumen Ejecutivo</mat-card-title>
        <mat-card-subtitle>Análisis completado el {{ apiResponse.timestamp | date:'dd/MM/yyyy HH:mm' }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-stats">
          <div class="stat-item">
            <span class="stat-number">{{ apiResponse.resultados?.length || 0 }}</span>
            <span class="stat-label">Indicadores procesados</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ resumenDesglosado.length }}</span>
            <span class="stat-label">Resultados generados</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Tabla de resultados -->
    <mat-card class="results-table-card">
      <mat-card-header>
        <mat-card-title>Resultados Detallados</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="resumenDesglosado" class="results-table">
            <!-- Columna Categoría -->
            <ng-container matColumnDef="categoria">
              <th mat-header-cell *matHeaderCellDef class="header-cell">Categoría</th>
              <td mat-cell *matCellDef="let element" class="data-cell category-cell">{{element.categoria}}</td>
            </ng-container>

            <!-- Columna Indicador -->
            <ng-container matColumnDef="indicador">
              <th mat-header-cell *matHeaderCellDef class="header-cell">Indicador</th>
              <td mat-cell *matCellDef="let element" class="data-cell indicator-cell">{{element.indicador}}</td>
            </ng-container>

            <!-- Columna Base de Datos -->
            <ng-container matColumnDef="baseData">
              <th mat-header-cell *matHeaderCellDef class="header-cell">Base de Datos</th>
              <td mat-cell *matCellDef="let element" class="data-cell database-cell">{{element.baseData}}</td>
            </ng-container>

            <!-- Columna Resultado -->
            <ng-container matColumnDef="resultado">
              <th mat-header-cell *matHeaderCellDef class="header-cell">Resultado</th>
              <td mat-cell *matCellDef="let element" class="data-cell result-cell">
                <span class="result-value">{{element.resultado | number:'1.2-2'}}</span>
              </td>
            </ng-container>

            <!-- Columna Pacientes -->
            <ng-container matColumnDef="numeroDePacientes">
              <th mat-header-cell *matHeaderCellDef class="header-cell">Nº Pacientes</th>
              <td mat-cell *matCellDef="let element" class="data-cell patients-cell">
                <span class="patients-count">{{element.numeroDePacientes | number}}</span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="summaryColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: summaryColumns;" class="data-row"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
