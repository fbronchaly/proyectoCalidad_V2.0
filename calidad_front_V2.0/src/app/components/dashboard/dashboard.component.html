<div class="dashboard-container">
  <!-- Header con logo -->
  <header class="dashboard-header">
    <div class="logo-container">
      <div class="logo-background">
        <img src="assets/imagenes/Logo-Retina-Movil.png" alt="Logo" class="logo">
      </div>
    </div>
    <div class="header-title">
      <h1>Panel de Mando</h1>
      <p>Sistema de Análisis de Indicadores de Hemodiálisis</p>
    </div>
  </header>

  <!-- Contenido principal en tres columnas -->
  <div class="main-content">
    <!-- COLUMNA IZQUIERDA: Configuración básica -->
    <div class="left-column">
      <div class="section-title">
        <span class="title-text">Configuración</span>
      </div>
      
      <!-- Card de bases de datos -->
      <mat-card class="config-card database-card">
        <mat-card-header>
          <mat-card-title>Bases de Datos</mat-card-title>
          <mat-card-subtitle>{{sel.getDatabases().length}} bases seleccionadas</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="selection-info">
            <div class="info-item" *ngIf="sel.getDatabases().length > 0">
              <span>{{sel.getDatabases().length}} base(s) de datos configurada(s)</span>
            </div>
            <div class="info-item warning" *ngIf="sel.getDatabases().length === 0">
              <span>No hay bases de datos seleccionadas</span>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <button mat-raised-button color="primary" class="config-btn" (click)="goToBases()">
            <span class="button-text">Elegir Bases de Datos</span>
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Card de indicadores -->
      <mat-card class="config-card indicators-card">
        <mat-card-header>
          <mat-card-title>Indicadores</mat-card-title>
          <mat-card-subtitle>{{sel.getIndicators().length}} indicadores seleccionados</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="selection-info">
            <div class="info-item" *ngIf="sel.getIndicators().length > 0">
              <span>{{sel.getIndicators().length}} indicador(es) configurado(s)</span>
            </div>
            <div class="info-item warning" *ngIf="sel.getIndicators().length === 0">
              <span>No hay indicadores seleccionados</span>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <button mat-raised-button color="primary" class="config-btn" (click)="goToIndicadores()">
            <span class="button-text">Elegir Indicadores</span>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- COLUMNAS CENTRALES: Calendario (ocupa 2 columnas) -->
    <div class="center-columns">
      <div class="section-title">
        <span class="title-text">Período de Análisis</span>
      </div>
      
      <!-- Card del calendario - ocupa las dos columnas centrales -->
      <mat-card class="config-card date-card">
        <mat-card-header>
          <mat-card-title>Rango de Fechas</mat-card-title>
          <mat-card-subtitle>Selecciona el período de análisis</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="date-inputs">
            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Fecha inicio</mat-label>
              <input matInput [matDatepicker]="startPicker" [value]="startDate"  (dateChange)="onStartDateChange($event.value)">
              <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Fecha fin</mat-label>
              <input matInput [matDatepicker]="endPicker" [value]="endDate" [max]="maxEndDate" (dateChange)="onEndDateChange($event.value)">
              <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <!-- Divisor -->
          <mat-divider class="my-3"></mat-divider>

          <!-- Selector rápido de rangos -->
          <div class="quick-range-selector">
            <h4 class="selector-title">Selección Rápida de Períodos</h4>
            <app-first-day-range-picker (rangeChange)="onQuickRangeChange($event)"></app-first-day-range-picker>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <button mat-raised-button color="warn" class="reset-btn" (click)="resetDates()">
            <span class="button-text">Reiniciar Todo</span>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- COLUMNA DERECHA: Análisis y resultados -->
    <div class="right-column">
      <!-- Sección de análisis -->
      <div class="section-title">
        <mat-icon>play_circle_filled</mat-icon>
        <span class="title-text">Ejecutar Análisis</span>
      </div>

      <!-- Card de análisis - ajustada para columna derecha -->
      <mat-card class="analysis-card">
        <mat-card-content>
          <div class="analysis-content">
            <div class="analysis-info">
              <h3>¿Listo para analizar?</h3>
              <p>Configura fechas, bases e indicadores.</p>
              
              <!-- Indicador de estado del sistema cuando está listo -->
              <div class="system-status" *ngIf="apiResponse && !loading">
                <div class="status-indicator ready">
                  <mat-icon>check_circle</mat-icon>
                  <span>Sistema listo para nuevo análisis</span>
                </div>
              </div>

              <!-- NUEVO: Indicador de progreso durante las consultas -->
              <div class="system-status" *ngIf="loading">
                <div class="progress-indicator">
                  <div class="progress-header">
                    <mat-icon>analytics</mat-icon>
                    <span class="progress-title">Procesando Análisis</span>
                  </div>
                  
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="progressPercentage"
                    color="primary">
                  </mat-progress-bar>
                  
                  <div class="progress-info">
                    <span class="progress-text">{{ progressMessage }}</span>
                    <span class="progress-percentage">{{ progressPercentage }}%</span>
                  </div>
                  
                  <div class="time-remaining" *ngIf="timeRemaining > 0">
                    <mat-icon>schedule</mat-icon>
                    <span>Tiempo estimado: {{ formatTimeRemaining(timeRemaining) }}</span>
                  </div>
                </div>
              </div>
              
              <div class="readiness-check">
                <div class="check-item" [class.ready]="startDate && endDate">
                  <mat-icon>{{startDate && endDate ? 'check_circle' : 'radio_button_unchecked'}}</mat-icon>
                  <span>Fechas</span>
                </div>
                <div class="check-item" [class.ready]="sel.getDatabases().length > 0">
                  <mat-icon>{{sel.getDatabases().length > 0 ? 'check_circle' : 'radio_button_unchecked'}}</mat-icon>
                  <span>Bases</span>
                </div>
                <div class="check-item" [class.ready]="sel.getIndicators().length > 0">
                  <mat-icon>{{sel.getIndicators().length > 0 ? 'check_circle' : 'radio_button_unchecked'}}</mat-icon>
                  <span>Indicadores</span>
                </div>
              </div>
            </div>
            
            <div class="analysis-action">
              <button 
                mat-raised-button 
                color="accent" 
                class="analyze-btn"
                [class.ready-for-new]="apiResponse && readyToSendFront"
                [disabled]="!readyToSendFront || loading"
                (click)="sendToBack()">
                <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
                <mat-icon *ngIf="!loading && apiResponse && readyToSendFront">refresh</mat-icon>
                <mat-icon *ngIf="!loading && !apiResponse && readyToSendFront">play_arrow</mat-icon>
                <span class="button-text" *ngIf="!loading && !apiResponse">Iniciar Análisis</span>
                <span class="button-text" *ngIf="!loading && apiResponse">Nuevo Análisis</span>
                <span class="button-text" *ngIf="loading">Procesando...</span>
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Sección de resultados - abajo ocupando todo el ancho -->
  <div class="results-section" *ngIf="apiResponse">
    <div class="section-title">
      <mat-icon>assessment</mat-icon>
      <span class="title-text">Resultados del Análisis</span>
    </div>

    <!-- Mensaje de error si no fue exitoso -->
    <mat-card class="error-card" *ngIf="apiResponse && !apiResponse.success">
      <mat-card-content>
        <div class="error-content">
          <mat-icon color="warn">error</mat-icon>
          <div>
            <h3>Error en el Análisis</h3>
            <p>{{ apiResponse.message }}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Resultados exitosos O con errores parciales pero con datos -->
    <div *ngIf="apiResponse && (apiResponse.success || (apiResponse.resultados && apiResponse.resultados.length > 0))">
      <!-- Resumen general -->
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Resumen Ejecutivo</mat-card-title>
          <mat-card-subtitle>
            Análisis {{ apiResponse.success ? 'completado' : 'parcial' }} 
            el {{ formatDate(apiResponse.timestamp, 'dd/MM/yyyy HH:mm') }}
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="summary-stats">
            <div class="stat-item">
              <span class="stat-number">{{ apiResponse.resultados?.length || 0 }}</span>
              <span class="stat-label">Indicadores procesados</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">{{ tableData.length }}</span>
              <span class="stat-label">Resultados generados</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">{{ sel.getDatabases().length }}</span>
              <span class="stat-label">Bases analizadas</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- TABLA BOOTSTRAP -->
      <mat-card class="results-table-card" *ngIf="tableData.length > 0">
        <mat-card-header>
          <mat-card-title>Todos los Resultados</mat-card-title>
          <mat-card-subtitle>Vista completa de todos los indicadores y bases de datos ({{ tableData.length }} resultados)</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
              <thead class="table-dark">
                <tr>
                  <th scope="col">Categoría</th>
                  <th scope="col">Indicador</th>
                  <th scope="col">Base de Datos</th>
                  <th scope="col" class="text-end">Resultado</th>
                  <th scope="col" class="text-end">Pacientes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let element of tableData">
                  <td>{{ element.categoria || 'N/A' }}</td>
                  <td>{{ element.indicador || 'N/A' }}</td>
                  <td><span class="badge bg-primary">{{ element.baseData || 'N/A' }}</span></td>
                  <td class="text-end">
                    <span class="badge bg-success">
                      {{ formatNumber(element.resultado, 2) }}
                    </span>
                  </td>
                  <td class="text-end">
                    {{ formatInteger(element.numeroDePacientes) }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
      
      <!-- Mensaje si no hay resultados desglosados -->
      <mat-card class="no-results-card" *ngIf="tableData.length === 0">
        <mat-card-content>
          <div class="no-results-content">
            <mat-icon color="warn">warning</mat-icon>
            <div>
              <h3>Sin Datos Desglosados</h3>
              <p>Se procesaron {{ apiResponse.resultados?.length || 0 }} indicadores, pero no se generaron resultados detallados.</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      
      <!-- Sección de resultados por indicador (expandible) -->
      <div class="indicators-section" *ngIf="apiResponse.resultados && apiResponse.resultados.length > 0">
        <h3 class="indicators-title">Desglose por Indicador</h3>
        
        <mat-card class="indicator-card" *ngFor="let indicador of apiResponse.resultados; let i = index">
          <mat-card-header>
            <mat-card-title>{{ indicador.indicador }}</mat-card-title>
            <mat-card-subtitle>
              {{ indicador.categoria }} • {{ indicador.resultados.length }} resultado(s)
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <div class="indicator-details">
              <p><strong>ID:</strong> {{ indicador.id_code }}</p>
              <p><strong>Período:</strong> 
                <span *ngIf="indicador.intervalo?.fechaInicio && indicador.intervalo?.fechaFin">
                  {{ formatDate(indicador.intervalo.fechaInicio) }} - 
                  {{ formatDate(indicador.intervalo.fechaFin) }}
                </span>
                <span *ngIf="!indicador.intervalo?.fechaInicio || !indicador.intervalo?.fechaFin">
                  Sin período definido
                </span>
              </p>
              
              <div class="totals-summary" *ngIf="indicador.totales">
                <div class="total-item">
                  <span class="total-label">Total Resultado:</span>
                  <span class="total-value">{{ formatNumber(indicador.totales.resultado, 2) }}</span>
                </div>
                <div class="total-item">
                  <span class="total-label">Total Pacientes:</span>
                  <span class="total-value">{{ formatInteger(indicador.totales.numero_pacientes) }}</span>
                </div>
              </div>

              <div class="results-by-db">
                <h4>Resultados por Base de Datos:</h4>
                <div class="db-result" *ngFor="let resultado of indicador.resultados">
                  <div class="db-name">{{ resultado.baseData }}</div>
                  <div class="db-values">
                    <span class="db-result-value">{{ formatNumber(resultado.resultado, 2) }}</span>
                    <span class="db-patients">{{ formatInteger(resultado.numeroDePacientes) }} pacientes</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Mensaje si no hay datos en absoluto -->
    <mat-card class="no-data-card" *ngIf="apiResponse && !apiResponse.resultados">
      <mat-card-content>
        <div class="no-data-content">
          <mat-icon color="warn">info</mat-icon>
          <div>
            <h3>Sin Resultados</h3>
            <p>No se recibieron datos del análisis.</p>
            <p><strong>Mensaje:</strong> {{ apiResponse.message }}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
