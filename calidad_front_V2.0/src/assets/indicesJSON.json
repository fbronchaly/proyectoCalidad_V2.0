[
  {
    "id_code": "TF6T359S",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº total de sesiones  de HD de crónicos realizadas (total -  incluye desplazados",
    "unidad":"Sesiones",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT s.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "UEYRXMS5",
    "categoria": "Actividad Asistencial HD crónicos",
    "indicador": "Nº total de sesiones de HD de crónicos realizadas (convencional + HDF on line + HD expandida) en el periodo",
    "unidad":"Sesiones",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO,0)=0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND s.TIPOHEMO IN (<CODIGOS_HD_TOTAL>);"
  },
  {
    "id_code": "UGYUXMS8",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº total de sesiones  de HD on line de crónicos  realizadas (ATENCION¡¡¡ El mismo paciente puede estar en otra modalidad por lo que la suma no da el valor absoluto de los pacientes ) ",
    "unidad":"Sesiones",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND s.TIPOHEMO IN (<CODIGOS_HD_OL>);"
  },
  {
    "id_code": "BXZ15OPB",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº total de sesiones  de HD convencional  de crónicos  realizadas ( ATENCION¡¡¡ El mismo paciente puede estar en otra modalidad por lo que la suma no da el valor absoluto de los pacientes) ",
    "unidad":"Sesiones",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND  s.TIPOHEMO IN (<CODIGOS_HD_CONV>);"
  },

  {
    "id_code": "9AV891DU",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº total de sesiones  de HD expandida  de crónicos  realizadas (ATENCION¡¡¡ El mismo paciente puede estar en otra modalidad por lo que la suma no da el valor absoluto de los pacientes) ",
    "unidad":"Sesiones",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND s.TIPOHEMO IN (<CODIGOS_HD_EXT>);"
  },
  {
    "id_code": "YLVJ7PUD",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº de pacientes de HD de crónicos  prevalentes de periodo =dializados a lo largo del periodo  ( suma de todos los pacientes desde el inicio del periodo hasta el final del periodo) ",
    "unidad":"Pacientes",
    "template": "SELECT COUNT(DISTINCT p.NREGGEN) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE  p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
    
  },
  {
    "id_code": "568BL7OH",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº de pacientes de HD de crónicos  prevalentes ultimo dia de periodo (fotografía de la fecha fin del periodo elegido)  ",
    "unidad":"Pacientes",
    "template": "WITH ULT_SESION AS (SELECT s.NREGGEN, MAX(s.FECHA) AS FECHA_ULT FROM SESION s WHERE s.FECHA <= :FECHAFIN AND s.FECHA >= :FECHAINI_CALCULADA GROUP BY s.NREGGEN), PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN ULT_SESION us ON us.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN))) SELECT COUNT(*) AS resultado, COUNT(*) AS numero_pacientes FROM PREVALENTES;"
  
  },
  {
    "id_code": "DPRRPAB3",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº de pacientes de HD de crónicos  incidentes a lo largo  del periodo ( suma de todos los pacientes desde el inicio del periodo hasta el final del periodo) ",
    "unidad":"Pacientes",
    "template": "SELECT COUNT(DISTINCT p.NREGGEN) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND p.DESPLAZADO = 0  AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "L2KRFUEQ",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº de bajas  de HD de crónicos (trasplante, fallecimiento, otros) (  suma de todos los pacientes desde el inicio del periodo hasta el final del periodo) ",
    "unidad":"Bajas",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT i.NREGGEN) AS numero_pacientes FROM INCIDENCIAS i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO,0) = 0 AND i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND i.CAUSABAJA IN ('P','E','R','M','T','N','B');"
  },
  {
    "id_code": "NCENQQAN",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº de trasplantes de HD de crónicos (  suma de todos los pacientes desde el inicio del periodo hasta el final del periodo) ",
    "unidad":"Transplante",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT i.NREGGEN) AS numero_pacientes FROM INCIDENCIAS i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO,0) = 0 AND i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND i.CAUSABAJA = 'P';"
  },
  {
    "id_code": "5OBGMVDT",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº de fallecimientos  de HD de crónicos ( suma de todos los pacientes desde el inicio del periodo hasta el final del periodo) ",
    "unidad":"Fallecimientos",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT i.NREGGEN) AS numero_pacientes FROM INCIDENCIAS i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO,0) = 0 AND i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND i.CAUSABAJA = 'E';"
  },
  {
    "id_code": "GJ16QLH1",
    "categoria": "Actividad Asistencial HD crónicos ",
    "indicador": "Nº de traslados de HD de crónicos a otros centros u hospitales  ( suma de todos los pacientes desde el inicio del periodo hasta el final del periodo) ",
    "unidad":"Traslados",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT i.NREGGEN) AS numero_pacientes FROM INCIDENCIAS i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO,0) = 0 AND i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND i.CAUSABAJA = 'T';"
  },
  {
    "id_code": "MHGMU6OQ",
   "categoria": "Actividad Asistencial HD crónicos",
   "indicador": "Nº de pacientes HD crónicos prevalentes con nº de sesiones semanales = 3 (fotografía a FECHAFIN)",
   "unidad":"Pacientes",
   "template": "WITH ULT_SESION AS (SELECT s.NREGGEN, MAX(s.FECHA) AS FECHA_ULT FROM SESION s WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY s.NREGGEN), PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN ULT_SESION us ON us.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO,0)=0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA=i.CAUSABAJA AND cb.TIPO='B' WHERE i.NREGGEN=p.NREGGEN AND i.FECHAINI<=:FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN>=:FECHAFIN))), LAST_PAUTA AS (SELECT h.NREGGEN, MAX(h.FECHA) AS FECHA_ULT FROM HISTPAUTA h JOIN PREVALENTES p ON p.NREGGEN=h.NREGGEN WHERE h.FECHA<=:FECHAFIN GROUP BY h.NREGGEN), PAUTA_ULT AS (SELECT h.NREGGEN, h.SESIONSEMANA FROM HISTPAUTA h JOIN LAST_PAUTA lp ON lp.NREGGEN=h.NREGGEN AND lp.FECHA_ULT=h.FECHA) SELECT COUNT(DISTINCT CASE WHEN pu.SESIONSEMANA=3 THEN pu.NREGGEN END) AS RESULTADO, (SELECT COUNT(*) FROM PREVALENTES) AS NUMERO_PACIENTES FROM PAUTA_ULT pu"
  },
  {
    "id_code": "5FGTWVMQ",
    "categoria": "Actividad Asistencial HD crónicos",
    "indicador": "Nº de pacientes HD crónicos prevalentes con nº de sesiones semanales < 3 (fotografía a FECHAFIN)",
    "unidad":"Pacientes",
    "template": "WITH ULT_SESION AS (SELECT s.NREGGEN, MAX(s.FECHA) AS FECHA_ULT FROM SESION s WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY s.NREGGEN), PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN ULT_SESION us ON us.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO,0)=0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA=i.CAUSABAJA AND cb.TIPO='B' WHERE i.NREGGEN=p.NREGGEN AND i.FECHAINI<=:FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN>=:FECHAFIN))), LAST_PAUTA AS (SELECT h.NREGGEN, MAX(h.FECHA) AS FECHA_ULT FROM HISTPAUTA h JOIN PREVALENTES p ON p.NREGGEN=h.NREGGEN WHERE h.FECHA<=:FECHAFIN GROUP BY h.NREGGEN), PAUTA_ULT AS (SELECT h.NREGGEN, h.SESIONSEMANA FROM HISTPAUTA h JOIN LAST_PAUTA lp ON lp.NREGGEN=h.NREGGEN AND lp.FECHA_ULT=h.FECHA) SELECT COUNT(DISTINCT CASE WHEN pu.SESIONSEMANA<3 THEN pu.NREGGEN END) AS RESULTADO, (SELECT COUNT(*) FROM PREVALENTES) AS NUMERO_PACIENTES FROM PAUTA_ULT pu"
  },
  {
    "id_code": "IZUSQSRH",
    "categoria": "Actividad Asistencial HD crónicos",
    "indicador": "Nº de pacientes HD crónicos prevalentes con nº de sesiones semanales > 3 (fotografía a FECHAFIN)",
    "unidad":"Pacientes",
    "template": "WITH ULT_SESION AS (SELECT s.NREGGEN, MAX(s.FECHA) AS FECHA_ULT FROM SESION s WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY s.NREGGEN), PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN ULT_SESION us ON us.NREGGEN=p.NREGGEN WHERE p.MODAL_TRAT='H' AND COALESCE(p.DESPLAZADO,0)=0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA=i.CAUSABAJA AND cb.TIPO='B' WHERE i.NREGGEN=p.NREGGEN AND i.FECHAINI<=:FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN>=:FECHAFIN))), LAST_PAUTA AS (SELECT h.NREGGEN, MAX(h.FECHA) AS FECHA_ULT FROM HISTPAUTA h JOIN PREVALENTES p ON p.NREGGEN=h.NREGGEN WHERE h.FECHA<=:FECHAFIN GROUP BY h.NREGGEN), PAUTA_ULT AS (SELECT h.NREGGEN, h.SESIONSEMANA FROM HISTPAUTA h JOIN LAST_PAUTA lp ON lp.NREGGEN=h.NREGGEN AND lp.FECHA_ULT=h.FECHA) SELECT COUNT(DISTINCT CASE WHEN pu.SESIONSEMANA>3 THEN pu.NREGGEN END) AS RESULTADO, (SELECT COUNT(*) FROM PREVALENTES) AS NUMERO_PACIENTES FROM PAUTA_ULT pu"
  },
  {
    "id_code": "PCT_LT3_HD",
    "categoria": "Actividad Asistencial HD crónicos",
    "indicador": "% de pacientes HD crónicos prevalentes con nº de sesiones semanales < 3 (fotografía a FECHAFIN)",
    "unidad":"%",
    "template": "WITH ULT_SESION AS (SELECT s.NREGGEN, MAX(s.FECHA) AS FECHA_ULT FROM SESION s WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY s.NREGGEN), PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN ULT_SESION us ON us.NREGGEN=p.NREGGEN WHERE p.MODAL_TRAT='H' AND COALESCE(p.DESPLAZADO,0)=0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA=i.CAUSABAJA AND cb.TIPO='B' WHERE i.NREGGEN=p.NREGGEN AND i.FECHAINI<=:FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN>=:FECHAFIN))), LAST_PAUTA AS (SELECT h.NREGGEN, MAX(h.FECHA) AS FECHA_ULT FROM HISTPAUTA h JOIN PREVALENTES p ON p.NREGGEN=h.NREGGEN WHERE h.FECHA<=:FECHAFIN GROUP BY h.NREGGEN), PAUTA_ULT AS (SELECT h.NREGGEN, h.SESIONSEMANA FROM HISTPAUTA h JOIN LAST_PAUTA lp ON lp.NREGGEN=h.NREGGEN AND lp.FECHA_ULT=h.FECHA) SELECT CAST(100.0 * COUNT(DISTINCT CASE WHEN pu.SESIONSEMANA<3 THEN pu.NREGGEN END) / NULLIF((SELECT COUNT(*) FROM PREVALENTES),0) AS NUMERIC(10,2)) AS RESULTADO, (SELECT COUNT(*) FROM PREVALENTES) AS NUMERO_PACIENTES FROM PAUTA_ULT pu"
  },
  {
    "id_code": "PCT_EQ3_HD",
    "categoria": "Actividad Asistencial HD crónicos",
    "indicador": "% de pacientes HD crónicos prevalentes con nº de sesiones semanales = 3 (fotografía a FECHAFIN)",
    "unidad":"%",
    "template": "WITH ULT_SESION AS (SELECT s.NREGGEN, MAX(s.FECHA) AS FECHA_ULT FROM SESION s WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY s.NREGGEN), PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN ULT_SESION us ON us.NREGGEN=p.NREGGEN WHERE p.MODAL_TRAT='H' AND COALESCE(p.DESPLAZADO,0)=0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA=i.CAUSABAJA AND cb.TIPO='B' WHERE i.NREGGEN=p.NREGGEN AND i.FECHAINI<=:FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN>=:FECHAFIN))), LAST_PAUTA AS (SELECT h.NREGGEN, MAX(h.FECHA) AS FECHA_ULT FROM HISTPAUTA h JOIN PREVALENTES p ON p.NREGGEN=h.NREGGEN WHERE h.FECHA<=:FECHAFIN GROUP BY h.NREGGEN), PAUTA_ULT AS (SELECT h.NREGGEN, h.SESIONSEMANA FROM HISTPAUTA h JOIN LAST_PAUTA lp ON lp.NREGGEN=h.NREGGEN AND lp.FECHA_ULT=h.FECHA) SELECT CAST(100.0 * COUNT(DISTINCT CASE WHEN pu.SESIONSEMANA=3 THEN pu.NREGGEN END) / NULLIF((SELECT COUNT(*) FROM PREVALENTES),0) AS NUMERIC(10,2)) AS RESULTADO, (SELECT COUNT(*) FROM PREVALENTES) AS NUMERO_PACIENTES FROM PAUTA_ULT pu"
  },
  {
    "id_code": "PCT_GT3_HD",
    "categoria": "Actividad Asistencial HD crónicos",
    "indicador": "% de pacientes HD crónicos prevalentes con nº de sesiones semanales > 3 (fotografía a FECHAFIN)",
    "unidad":"%",
    "template": "WITH ULT_SESION AS (SELECT s.NREGGEN, MAX(s.FECHA) AS FECHA_ULT FROM SESION s WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY s.NREGGEN), PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN ULT_SESION us ON us.NREGGEN=p.NREGGEN WHERE p.MODAL_TRAT='H' AND COALESCE(p.DESPLAZADO,0)=0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA=i.CAUSABAJA AND cb.TIPO='B' WHERE i.NREGGEN=p.NREGGEN AND i.FECHAINI<=:FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN>=:FECHAFIN))), LAST_PAUTA AS (SELECT h.NREGGEN, MAX(h.FECHA) AS FECHA_ULT FROM HISTPAUTA h JOIN PREVALENTES p ON p.NREGGEN=h.NREGGEN WHERE h.FECHA<=:FECHAFIN GROUP BY h.NREGGEN), PAUTA_ULT AS (SELECT h.NREGGEN, h.SESIONSEMANA FROM HISTPAUTA h JOIN LAST_PAUTA lp ON lp.NREGGEN=h.NREGGEN AND lp.FECHA_ULT=h.FECHA) SELECT CAST(100.0 * COUNT(DISTINCT CASE WHEN pu.SESIONSEMANA>3 THEN pu.NREGGEN END) / NULLIF((SELECT COUNT(*) FROM PREVALENTES),0) AS NUMERIC(10,2)) AS RESULTADO, (SELECT COUNT(*) FROM PREVALENTES) AS NUMERO_PACIENTES FROM PAUTA_ULT pu"
  },
 
  {
    "id_code": "E5X6QMGB",
    "categoria": "Actividad HD desplazados",
    "indicador": "Nº total de sesiones de HD de desplazados realizadas",
    "unidad":"Sesiones",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'J' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "IZ941KIY",
    "categoria": "Actividad HD desplazados",
    "indicador": "Nº de pacientes HD desplazados prevalentes en periodo",
    "unidad":"Pacientes",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'J' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "TPQ73J37",
    "categoria": "Actividad HDD",
    "indicador": "Nº de pacientes HDD prevalentes en periodo",
    "unidad":"Pacientes",
    "template": "SELECT COUNT(DISTINCT p.NREGGEN) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND  s.TIPOHEMO IN (<CODIGOS_HD_OL>);"
  },
  {
    "id_code": "TPQ93K37",
    "categoria": "Actividad HDD",
    "indicador": "Nº de pacientes HDD incidentes en periodo",
    "unidad":"Pacientes",
    "template": "SELECT COUNT(DISTINCT p.NREGGEN) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE  p.DESPLAZADO = 0  AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN AND  s.TIPOHEMO IN (<CODIGOS_HD_OL>);"
  },
  {
    "id_code": "TPQ23K1S",
    "categoria": "Actividad HDD",
    "indicador": "Nº de pacientes HDD incidentes en ultimo dia de periodo",
    "unidad":"Pacientes",
    "template": "SELECT COUNT(DISTINCT p.NREGGEN) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI_CALCULADA AND :FECHAFIN AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN)) AND  s.TIPOHEMO IN (<CODIGOS_HD_OL>);"
  },
  
  {
    "id_code": "YHM109JA",
    "categoria": "Actividad DP",
    "indicador": "Nº de pacientes DP prevalentes en periodo",
    "unidad":"Pacientes",
    "template": "SELECT COUNT(DISTINCT s.NSESION) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'D' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "N9I9KUX8",
    "categoria": "Actividad Asistencial HD domiciliaria",
    "indicador": "Nº de pacientes de DP prevalentes ultimo dia de periodo  ",
    "unidad":"Pacientes",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p LEFT JOIN INCIDENCIAS i ON p.NREGGEN = i.NREGGEN AND i.FECHAFIN <= :FECHAFIN WHERE p.MODAL_TRAT = 'D' AND (i.CAUSABAJA IS NULL OR i.FECHAFIN > :FECHAFIN);"
  },
  {
    "id_code": "7OOUVY83",
    "categoria": "Actividad Asistencial HD Agudos",
    "indicador": "Nº total de sesiones  de HD de agudos  realizadas (  suma de todas las sesiones de HD desde el inicio del periodo hasta el final del periodo) ",
    "unidad":"Sesiones",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p LEFT JOIN INCIDENCIAS i ON p.NREGGEN = i.NREGGEN AND i.FECHAFIN <= :FECHAFIN WHERE p.MODAL_TRAT = 'A' AND (i.CAUSABAJA IS NULL OR i.FECHAFIN > :FECHAFIN);"
  },
  {
    "id_code": "6J6MZ5BU",
    "categoria": "Descripción población",
    "indicador": "Porcentaje de hombres dializados en periodo",
    "unidad":"%",
    "template": "SELECT (COUNT(DISTINCT CASE WHEN p.SEXO = 'H' THEN p.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT p.NREGGEN),0)) AS resultado, COUNT(DISTINCT CASE WHEN p.SEXO = 'H' THEN p.NREGGEN END) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "Z0M8YMW6",
    "categoria": "Descripción población",
    "indicador": "Porcentaje de mujeres dializadas en periodo",
    "unidad":"%",
    "template": "SELECT (COUNT(DISTINCT CASE WHEN p.SEXO = 'M' THEN p.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT p.NREGGEN),0)) AS resultado, COUNT(DISTINCT CASE WHEN p.SEXO = 'M' THEN p.NREGGEN END) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "84CI952I",
    "categoria": "Descripción población",
    "indicador": "Edad media de pacientes prevalentes en periodo",
    "unidad":"Edad", 
    "template": "SELECT AVG(CAST(DATEDIFF(DAY, p.FENAC, CAST(:FECHAFIN AS DATE)) / 365.25 AS DECIMAL(10,2))) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.MODAL_TRAT = 'H' AND p.FENAC IS NOT NULL AND s.FECHA BETWEEN CAST(:FECHAINI AS DATE) AND CAST(:FECHAFIN AS DATE);"
   },
   {
    "id_code": "84CI952IH",
    "categoria": "Descripción población",
    "indicador": "Edad media de pacientes prevalentes en periodo HOMBRES",
    "unidad":"Edad", 
    "template": "SELECT AVG(CAST(DATEDIFF(DAY, p.FENAC, CAST(:FECHAFIN AS DATE)) / 365.25 AS DECIMAL(10,2))) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.MODAL_TRAT = 'H' AND p.SEXO = 'H' AND p.FENAC IS NOT NULL AND s.FECHA BETWEEN CAST(:FECHAINI AS DATE) AND CAST(:FECHAFIN AS DATE);"
      },
   {
    "id_code": "84CI952IM",
    "categoria": "Descripción población",
    "indicador": "Edad media de pacientes prevalentes en periodo MUJERES",
    "unidad":"Edad",
    "template": "SELECT AVG(CAST(DATEDIFF(DAY, p.FENAC, CAST(:FECHAFIN AS DATE)) / 365.25 AS DECIMAL(10,2))) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.MODAL_TRAT = 'H' AND p.SEXO = 'M' AND p.FENAC IS NOT NULL AND s.FECHA BETWEEN CAST(:FECHAINI AS DATE) AND CAST(:FECHAFIN AS DATE);"
   },
  {
    "id_code": "YWHB0C0I",
    "categoria": "Descripción población",
    "indicador": "Edad media de pacientes incidentes en periodo",
    "unidad":"Edad",
    "template": "SELECT AVG(CAST(DATEDIFF(DAY, p.FENAC, p.FECH_INICIO_CENTRO) / 365.25 AS DECIMAL(10,2))) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.MODAL_TRAT = 'H' AND p.FENAC IS NOT NULL AND p.FECH_INICIO_CENTRO BETWEEN CAST(:FECHAINI AS DATE) AND CAST(:FECHAFIN AS DATE);"
    },
  {
    "id_code": "JVCBM8DE",
    "categoria": "Descripción población",
    "indicador": "% pacientes incidentes en periodo mayores de 80 años",
    "unidad":"%",
    "template": "SELECT (COUNT(CASE WHEN (DATEDIFF(DAY, p.FENAC, p.FECH_INICIO_CENTRO) / 365.25) >= 80 THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(*) AS numero_pacientes FROM PACIENTES p WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.MODAL_TRAT = 'H' AND p.FENAC IS NOT NULL AND p.FECH_INICIO_CENTRO BETWEEN CAST(:FECHAINI AS DATE) AND CAST(:FECHAFIN AS DATE);"
  },
  {
    "id_code": "KE6IQXRV",
    "categoria": "Descripción población",
    "indicador": "% pacientes prevalentes en periodo mayores de 80 años",
    "unidad":"%",
    "template": "WITH PREVALENTES AS ( SELECT DISTINCT p.NREGGEN, p.FENAC FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.MODAL_TRAT = 'H' AND p.FENAC IS NOT NULL AND s.FECHA BETWEEN CAST(:FECHAINI AS DATE) AND CAST(:FECHAFIN AS DATE) ) SELECT (SUM(CASE WHEN (DATEDIFF(DAY, p.FENAC, CAST(:FECHAFIN AS DATE)) / 365.25) >= 80 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(*) AS numero_pacientes FROM PREVALENTES p;"
      },
  {
    "id_code": "MUV2G6VE",
    "categoria": "Descripcion población ( diabetes)",
    "indicador": "Porcentaje de pacientes incidentes en periodo con nefropatia diabetica ( suma de todos los pacientes  nuevos con nefropatia diabetica desde el inicio del periodo hasta el final del periodo / nº total de pacienets nuevos en periodo) ",
    "unidad":"%",
    "template": "SELECT CASE WHEN COUNT(DISTINCT p.NREGGEN) = 0 THEN NULL ELSE (COUNT(DISTINCT CASE WHEN p.ETIOLOGIA IN (80, 81) THEN p.NREGGEN END) * 100.0 / COUNT(DISTINCT p.NREGGEN)) END AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN;"
    },
  {
    "id_code": "X86NJ54L",
    "categoria": "Descripcion población ( diabetes)",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con nefropatia diabetica ( suma de todos los pacientes   con nefropatia diabetica desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo) ",
    "unidad":"%",
    "template": "SELECT CASE WHEN COUNT(DISTINCT p.NREGGEN) = 0 THEN NULL ELSE (COUNT(DISTINCT CASE WHEN p.ETIOLOGIA IN (80, 81) THEN p.NREGGEN END) * 100.0 / COUNT(DISTINCT p.NREGGEN)) END AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;;"
  },
  {
    "id_code": "COMORB_FRAIL_INC",
    "categoria": "Comorbilidad - Fragilidad",
    "indicador": "Porcentaje de pacientes incidentes en periodo con fragilidad (suma de todos los pacientes nuevos con fragilidad desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo)",
    "unidad": "%",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoFRAIL AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_FRAIL> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), FRAIL_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoFRAIL u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN fp.PUNTOS_TOT >= 3 THEN fp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pi.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pi.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN fp.PUNTOS_TOT >= 3 THEN fp.NREGGEN END) AS numerador FROM PacientesIncidentes pi LEFT JOIN FRAIL_Punt fp ON fp.NREGGEN = pi.NREGGEN;"
  },
  {
    "id_code": "COMORB_FRAIL_PREV",
    "categoria": "Comorbilidad - Fragilidad",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con fragilidad (suma de todos los pacientes con fragilidad desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoFRAIL AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_FRAIL> AND t.FECHA <= :FECHAFIN GROUP BY t.NREGGEN ), FRAIL_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoFRAIL u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN fp.PUNTOS_TOT >= 3 THEN pp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN fp.PUNTOS_TOT >= 3 THEN pp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN FRAIL_Punt fp ON fp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_SARC_INC",
    "categoria": "Comorbilidad - Sarcopenia",
    "indicador": "Porcentaje de pacientes incidentes en periodo con sarcopenia (suma de todos los pacientes nuevos con sarcopenia desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo)",
    "unidad": "%",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoSARCF AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_SARCF> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), SARCF_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoSARCF u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN sp.PUNTOS_TOT > 3 THEN sp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pi.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pi.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN sp.PUNTOS_TOT > 3 THEN sp.NREGGEN END) AS numerador FROM PacientesIncidentes pi LEFT JOIN SARCF_Punt sp ON sp.NREGGEN = pi.NREGGEN;"
  },
  {
    "id_code": "COMORB_SARC_PREV",
    "categoria": "Comorbilidad - Sarcopenia",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con sarcopenia (suma de todos los pacientes con sarcopenia desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoSARCF AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_SARCF> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesPrevalentes) GROUP BY t.NREGGEN ), SARCF_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoSARCF u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN sp.PUNTOS_TOT > 3 THEN sp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN sp.PUNTOS_TOT > 3 THEN sp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN SARCF_Punt sp ON sp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_MNA_INC",
    "categoria": "Comorbilidad - Nutrición",
    "indicador": "Porcentaje de pacientes incidentes en periodo con desnutrición / riesgo (suma de todos los pacientes nuevos con desnutrición o en riesgo de desnutrición desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo)",
    "unidad": "%",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoMNA AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_MNA> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), MNA_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoMNA u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN mp.PUNTOS_TOT <= 11 THEN mp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pi.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pi.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN mp.PUNTOS_TOT <= 11 THEN mp.NREGGEN END) AS numerador FROM PacientesIncidentes pi LEFT JOIN MNA_Punt mp ON mp.NREGGEN = pi.NREGGEN;"
  },
  {
    "id_code": "COMORB_MNA_PREV",
    "categoria": "Comorbilidad - Nutrición",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con desnutrición / riesgo (suma de todos los pacientes con desnutrición o en riesgo de desnutrición desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoMNA AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_MNA> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesPrevalentes) GROUP BY t.NREGGEN ), MNA_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoMNA u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN mp.PUNTOS_TOT <= 11 THEN mp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN mp.PUNTOS_TOT <= 11 THEN mp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN MNA_Punt mp ON mp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_BARTHEL_INC",
    "categoria": "Comorbilidad - Dependencia",
    "indicador": "Porcentaje de pacientes incidentes en periodo con dependencia moderada-severa a ABVD (suma de todos los pacientes nuevos con dependencia moderada-severa desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo)",
    "unidad": "%",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoBARTHEL AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_BARTHEL> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), BARTHEL_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoBARTHEL u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN bp.PUNTOS_TOT <= 75 THEN bp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pi.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pi.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN bp.PUNTOS_TOT <= 75 THEN bp.NREGGEN END) AS numerador FROM PacientesIncidentes pi LEFT JOIN BARTHEL_Punt bp ON bp.NREGGEN = pi.NREGGEN;"
  },
  {
    "id_code": "COMORB_BARTHEL_PREV",
    "categoria": "Comorbilidad - Dependencia",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con dependencia moderada-severa a ABVD (suma de todos los pacientes con dependencia moderada-severa desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoBARTHEL AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_BARTHEL> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesPrevalentes) GROUP BY t.NREGGEN ), BARTHEL_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoBARTHEL u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN bp.PUNTOS_TOT <= 75 THEN bp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN bp.PUNTOS_TOT <= 75 THEN bp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN BARTHEL_Punt bp ON bp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_LAWTON_INC",
    "categoria": "Comorbilidad - Dependencia AIVD",
    "indicador": "Porcentaje de pacientes incidentes en periodo con dependencia en AIVD (suma de todos los pacientes nuevos con dependencia en AIVD desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo)",
    "unidad": "%",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoLAWTON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_LAWTON> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), LAWTON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoLAWTON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN lp.PUNTOS_TOT < 8 THEN lp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pi.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pi.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN lp.PUNTOS_TOT < 8 THEN lp.NREGGEN END) AS numerador FROM PacientesIncidentes pi LEFT JOIN LAWTON_Punt lp ON lp.NREGGEN = pi.NREGGEN;"
  },
  {
    "id_code": "COMORB_LAWTON_PREV",
    "categoria": "Comorbilidad - Dependencia AIVD",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con dependencia en AIVD (suma de todos los pacientes con dependencia en AIVD desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoLAWTON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_LAWTON> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesPrevalentes) GROUP BY t.NREGGEN ), LAWTON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoLAWTON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN lp.PUNTOS_TOT < 8 THEN lp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN lp.PUNTOS_TOT < 8 THEN lp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN LAWTON_Punt lp ON lp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_CHARLSON_INC",
    "categoria": "Comorbilidad - Comorbilidad",
    "indicador": "Puntuación media de índice de Charlson en pacientes incidentes en periodo",
    "unidad": "Puntos",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoCHARLSON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_CHARLSON> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), CHARLSON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoCHARLSON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(AVG(CAST(cp.PUNTOS_TOT AS NUMERIC(10,2))) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT cp.NREGGEN) AS numero_pacientes FROM CHARLSON_Punt cp;"
  },
  {
    "id_code": "COMORB_CHARLSON_PREV",
    "categoria": "Comorbilidad - Comorbilidad",
    "indicador": "Puntuación media de índice de Charlson en pacientes prevalentes en periodo",
    "unidad": "Puntos",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoCHARLSON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_CHARLSON> AND t.FECHA <= :FECHAFIN GROUP BY t.NREGGEN ), CHARLSON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoCHARLSON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(AVG(CAST(cp.PUNTOS_TOT AS NUMERIC(10,2))) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT cp.NREGGEN) AS numero_pacientes FROM CHARLSON_Punt cp;"
  },
  {
    "id_code": "COMORB_CHARLSON_ALTO_PREV",
    "categoria": "Comorbilidad - Comorbilidad",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con alta comorbilidad (suma de todos los pacientes con Charlson >= 5 desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoCHARLSON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_CHARLSON> AND t.FECHA <= :FECHAFIN GROUP BY t.NREGGEN ), CHARLSON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoCHARLSON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN cp.PUNTOS_TOT >= 5 THEN cp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN cp.PUNTOS_TOT >= 5 THEN cp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN CHARLSON_Punt cp ON cp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_DOWNTON_INC",
    "categoria": "Comorbilidad - Riesgo de Caídas",
    "indicador": "Porcentaje de pacientes incidentes en periodo con riesgo de caídas (suma de todos los pacientes nuevos con riesgo de caídas desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo)",
    "unidad": "%",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoDOWNTON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_DOWNTON> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), DOWNTON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoDOWNTON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN dp.PUNTOS_TOT >= 3 THEN dp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pi.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pi.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN dp.PUNTOS_TOT >= 3 THEN dp.NREGGEN END) AS numerador FROM PacientesIncidentes pi LEFT JOIN DOWNTON_Punt dp ON dp.NREGGEN = pi.NREGGEN;"
  },
  {
    "id_code": "COMORB_DOWNTON_PREV",
    "categoria": "Comorbilidad - Riesgo de Caídas",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con riesgo de caídas (suma de todos los pacientes con riesgo de caídas desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoDOWNTON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_DOWNTON> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesPrevalentes) GROUP BY t.NREGGEN ), DOWNTON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoDOWNTON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN dp.PUNTOS_TOT >= 3 THEN dp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN dp.PUNTOS_TOT >= 3 THEN dp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN DOWNTON_Punt dp ON dp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_PHQ4_INC",
    "categoria": "Comorbilidad - Salud Mental",
    "indicador": "Porcentaje de pacientes incidentes en periodo con síntomas de ansiedad/depresión (suma de todos los pacientes nuevos con síntomas de ansiedad/depresión desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo)",
    "unidad": "%",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoPHQ4 AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_PHQ4> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), PHQ4_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoPHQ4 u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN pp.PUNTOS_TOT >= 6 THEN pp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pi.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pi.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN pp.PUNTOS_TOT >= 6 THEN pp.NREGGEN END) AS numerador FROM PacientesIncidentes pi LEFT JOIN PHQ4_Punt pp ON pp.NREGGEN = pi.NREGGEN;"
  },
  {
    "id_code": "COMORB_PHQ4_PREV",
    "categoria": "Comorbilidad - Salud Mental",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con síntomas de ansiedad/depresión (suma de todos los pacientes con síntomas de ansiedad/depresión desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoPHQ4 AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_PHQ4> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesPrevalentes) GROUP BY t.NREGGEN ), PHQ4_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoPHQ4 u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN phq.PUNTOS_TOT >= 6 THEN phq.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN phq.PUNTOS_TOT >= 6 THEN phq.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN PHQ4_Punt phq ON phq.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_GIJON_INC",
    "categoria": "Comorbilidad - Riesgo Social",
    "indicador": "Porcentaje de pacientes incidentes en periodo con riesgo social (suma de todos los pacientes nuevos con riesgo social desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo)",
    "unidad": "%",
    "template": "WITH PacientesIncidentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), UltimoGIJON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_GIJON> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesIncidentes) GROUP BY t.NREGGEN ), GIJON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoGIJON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN gp.PUNTOS_TOT > 10 THEN gp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pi.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pi.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN gp.PUNTOS_TOT > 10 THEN gp.NREGGEN END) AS numerador FROM PacientesIncidentes pi LEFT JOIN GIJON_Punt gp ON gp.NREGGEN = pi.NREGGEN;"
  },
  {
    "id_code": "COMORB_GIJON_PREV",
    "categoria": "Comorbilidad - Riesgo Social",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con riesgo social (suma de todos los pacientes con riesgo social desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoGIJON AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_GIJON> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND t.NREGGEN IN (SELECT NREGGEN FROM PacientesPrevalentes) GROUP BY t.NREGGEN ), GIJON_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoGIJON u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN gp.PUNTOS_TOT > 10 THEN gp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN gp.PUNTOS_TOT > 10 THEN gp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN GIJON_Punt gp ON gp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_MULTI_FRAIL_SARC",
    "categoria": "Comorbilidad - Síndromes Múltiples",
    "indicador": "Porcentaje de pacientes prevalentes en periodo con fragilidad Y sarcopenia (suma de todos los pacientes con ambas condiciones desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), UltimoFRAIL AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_FRAIL> AND t.FECHA <= :FECHAFIN GROUP BY t.NREGGEN ), FRAIL_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoFRAIL u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ), UltimoSARCF AS ( SELECT t.NREGGEN, MAX(t.FECHA) AS FECHA_MAX FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_SARCF> AND t.FECHA <= :FECHAFIN GROUP BY t.NREGGEN ), SARCF_Punt AS ( SELECT tp.NREGGEN, tp.PUNTOS_TOT FROM TEST_PAC tp JOIN UltimoSARCF u ON tp.NREGGEN = u.NREGGEN AND tp.FECHA = u.FECHA_MAX ) SELECT CAST(COUNT(DISTINCT CASE WHEN fp.PUNTOS_TOT >= 3 AND sp.PUNTOS_TOT > 3 THEN pp.NREGGEN END) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT CASE WHEN fp.PUNTOS_TOT >= 3 AND sp.PUNTOS_TOT > 3 THEN pp.NREGGEN END) AS numerador FROM PacientesPrevalentes pp LEFT JOIN FRAIL_Punt fp ON fp.NREGGEN = pp.NREGGEN LEFT JOIN SARCF_Punt sp ON sp.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_COBERTURA_FRAIL",
    "categoria": "Comorbilidad - Cobertura Screening",
    "indicador": "Porcentaje de cobertura de screening de fragilidad en periodo (suma de todos los pacientes con test FRAIL registrado desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), ConFRAIL AS ( SELECT DISTINCT t.NREGGEN FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_FRAIL> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN ) SELECT CAST(COUNT(DISTINCT cf.NREGGEN) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT cf.NREGGEN) AS numerador FROM PacientesPrevalentes pp LEFT JOIN ConFRAIL cf ON cf.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_COBERTURA_MNA",
    "categoria": "Comorbilidad - Cobertura Screening",
    "indicador": "Porcentaje de cobertura de screening nutricional en periodo (suma de todos los pacientes con test MNA registrado desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), ConMNA AS ( SELECT DISTINCT t.NREGGEN FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_MNA> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN ) SELECT CAST(COUNT(DISTINCT cm.NREGGEN) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT cm.NREGGEN) AS numerador FROM PacientesPrevalentes pp LEFT JOIN ConMNA cm ON cm.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "COMORB_COBERTURA_BARTHEL",
    "categoria": "Comorbilidad - Cobertura Screening",
    "indicador": "Porcentaje de cobertura de screening de dependencia ABVD en periodo (suma de todos los pacientes con test Barthel registrado desde el inicio del periodo hasta el final del periodo / nº total de pacientes en periodo)",
    "unidad": "%",
    "template": "WITH PacientesPrevalentes AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), ConBARTHEL AS ( SELECT DISTINCT t.NREGGEN FROM TEST_PAC t WHERE t.CODTEST = <CODTEST_BARTHEL> AND t.FECHA BETWEEN :FECHAINI AND :FECHAFIN ) SELECT CAST(COUNT(DISTINCT cb.NREGGEN) * 100.0 / NULLIF(COUNT(DISTINCT pp.NREGGEN), 0) AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pp.NREGGEN) AS numero_pacientes, COUNT(DISTINCT cb.NREGGEN) AS numerador FROM PacientesPrevalentes pp LEFT JOIN ConBARTHEL cb ON cb.NREGGEN = pp.NREGGEN;"
  },
  {
    "id_code": "M5T2UZS3",
    "categoria": "Resultados en Salud",
    "indicador": "Nº de ingresos de HD de crónicos ",
    "unidad":"Ingresos",
    "template": "WITH BASE AS (SELECT i.NREGGEN, CAST(i.FECHAINGRESO AS DATE) AS F_ING, CAST(i.FECHAALTA AS DATE) AS F_ALTA FROM INGRESOSHOSPITAL i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE COALESCE(p.DESPLAZADO,0) = 0 AND p.MODAL_TRAT = 'H' AND CAST(i.FECHAINGRESO AS DATE) <= CAST(:FECHAFIN AS DATE) AND i.FECHAALTA IS NOT NULL AND CAST(i.FECHAALTA AS DATE) BETWEEN CAST(:FECHAINI AS DATE) AND CAST(:FECHAFIN AS DATE)), FILT AS (SELECT NREGGEN, CASE WHEN F_ING < CAST(:FECHAINI AS DATE) THEN CAST(:FECHAINI AS DATE) ELSE F_ING END AS F_INI, F_ALTA AS F_FIN FROM BASE), DIAS_PAC AS (SELECT NREGGEN, SUM(DATEDIFF(DAY, F_INI, F_FIN) + 1) AS DIAS FROM FILT GROUP BY NREGGEN) SELECT COALESCE(AVG(DIAS), 0) AS resultado, COUNT(*) AS numero_pacientes FROM DIAS_PAC;"
  
  },
  {
    "id_code": "ZZK6OOQG",
    "categoria": "Resultados en Salud", 
    "indicador": "Dias de Ingreso por enfermo en HD en periodo (Media de Días por Ingreso por Paciente)",
    "unidad":"Dias",
    "template": "WITH BASE AS (SELECT i.NREGGEN, CAST(i.FECHAINGRESO AS DATE) AS F_ING, CAST(i.FECHAALTA AS DATE) AS F_ALTA FROM INGRESOSHOSPITAL i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE COALESCE(p.DESPLAZADO,0) = 0 AND p.MODAL_TRAT = 'H' AND CAST(i.FECHAINGRESO AS DATE) <= CAST(:FECHAFIN AS DATE) AND i.FECHAALTA IS NOT NULL AND CAST(i.FECHAALTA AS DATE) BETWEEN CAST(:FECHAINI AS DATE) AND CAST(:FECHAFIN AS DATE)), FILT AS (SELECT NREGGEN, CASE WHEN F_ING < CAST(:FECHAINI AS DATE) THEN CAST(:FECHAINI AS DATE) ELSE F_ING END AS F_INI, F_ALTA AS F_FIN FROM BASE), MEDIAS_PAC AS (SELECT NREGGEN, CAST(SUM(DATEDIFF(DAY, F_INI, F_FIN) + 1) AS FLOAT) / COUNT(*) AS MEDIA_DIAS_INDIVIDUAL FROM FILT GROUP BY NREGGEN) SELECT COALESCE(AVG(MEDIA_DIAS_INDIVIDUAL), 0) AS resultado, COUNT(*) AS numero_pacientes FROM MEDIAS_PAC;"
  
   },
  {
    
    "id_code": "F15FWUQ2",
    "categoria": "Resultados en salud",
    "indicador":  "Tasa de mortalidad en HD (%)",
    "unidad":"%",
    "template": "SELECT (CAST(t1.NUM_FALLECIDOS AS FLOAT) * 100) / NULLIF(CAST(t2.NUM_PACIENTES_PREVALENTES AS FLOAT), 0) AS resultado, t2.NUM_PACIENTES_PREVALENTES AS numero_pacientes FROM ( SELECT COUNT(DISTINCT i.NREGGEN) AS NUM_FALLECIDOS FROM INCIDENCIAS i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND i.CAUSABAJA = 'E' ) t1 CROSS JOIN ( SELECT COUNT(DISTINCT p.NREGGEN) AS NUM_PACIENTES_PREVALENTES FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ) t2;"   
  
  },
  {
    "id_code": "QBIJEYQX",
    "categoria": "Resultados en salud",
    "indicador": "Tasa de trasplante en pacientes HD crónicos",
    "unidad":"%",
    "template": "SELECT (CAST(t1.NUM_TRANSPLANTE AS FLOAT) * 100) / NULLIF(CAST(t2.NUM_PACIENTES_PREVALENTES AS FLOAT), 0) AS resultado, t2.NUM_PACIENTES_PREVALENTES AS numero_pacientes FROM ( SELECT COUNT(DISTINCT i.NREGGEN) AS NUM_TRANSPLANTE FROM INCIDENCIAS i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND i.CAUSABAJA = 'P' ) t1 CROSS JOIN ( SELECT COUNT(DISTINCT p.NREGGEN) AS NUM_PACIENTES_PREVALENTES FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ) t2;"   
  },
  {
    "id_code": "SME3GL83",
    "categoria": "Calidad Técnica ( Adecuación de HD)",
    "indicador": "Porcentaje de sesiones de HD  con  KT > 45 ( se incluyen solo pacientes con 3 sesiones/semana)",
    "unidad":"%",
    "template": "SELECT (SUM(CASE WHEN s.KT_FINAL > 45 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(DISTINCT x.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN JOIN ( SELECT p.NREGGEN, EXTRACT(YEAR FROM s.FECHA) AS ANIO, EXTRACT(WEEK FROM s.FECHA) AS SEMANA FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND p.DESPLAZADO = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY p.NREGGEN, EXTRACT(YEAR FROM s.FECHA), EXTRACT(WEEK FROM s.FECHA) HAVING COUNT(s.NSESION) = 3 ) x ON x.NREGGEN = s.NREGGEN AND EXTRACT(YEAR FROM s.FECHA) = x.ANIO AND EXTRACT(WEEK FROM s.FECHA) = x.SEMANA WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "22QO3IXQ",
    "categoria": "Calidad Técnica ( Adecuación de HD)",
    "indicador": "Porcentaje de sesiones de HD  con  KT > 45 en varones y > 40 en mujeres ( se incluyen solo pacientes con 3 sesiones/semana)",
    "unidad":"%",
    "template": "SELECT (SUM(CASE WHEN (p.SEXO = 'H' AND s.KT_FINAL > 45) OR (p.SEXO = 'M' AND s.KT_FINAL > 40) THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(DISTINCT x.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN JOIN ( SELECT p.NREGGEN, EXTRACT(YEAR FROM s.FECHA) AS ANIO, EXTRACT(WEEK FROM s.FECHA) AS SEMANA FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY p.NREGGEN, EXTRACT(YEAR FROM s.FECHA), EXTRACT(WEEK FROM s.FECHA) HAVING COUNT(s.NSESION) = 3 ) x ON x.NREGGEN = s.NREGGEN AND EXTRACT(YEAR FROM s.FECHA) = x.ANIO AND EXTRACT(WEEK FROM s.FECHA) = x.SEMANA WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "22QO5ZXQ",
    "categoria": "Calidad Técnica ( Adecuación de HD)",
    "indicador": "Porcentaje de sesiones de HD  con  KT > 45 en varones(Con relación a los varones se incluyen solo pacientes con 3 sesiones/semana)",
    "unidad":"%",
    "template": "SELECT (SUM(CASE WHEN s.KT_FINAL > 45 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(DISTINCT x.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN JOIN ( SELECT p.NREGGEN, EXTRACT(YEAR FROM s.FECHA) AS ANIO, EXTRACT(WEEK FROM s.FECHA) AS SEMANA FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.SEXO = 'H' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY p.NREGGEN, EXTRACT(YEAR FROM s.FECHA), EXTRACT(WEEK FROM s.FECHA) HAVING COUNT(s.NSESION) = 3 ) x ON x.NREGGEN = s.NREGGEN AND EXTRACT(YEAR FROM s.FECHA) = x.ANIO AND EXTRACT(WEEK FROM s.FECHA) = x.SEMANA WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.SEXO = 'H' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "22QO8VXQ",
    "categoria": "Calidad Técnica ( Adecuación de HD)",
    "indicador": "Porcentaje de sesiones de HD  con  KT > 40 en mujeres (Con relación a los mujeres se incluyen solo pacientes con 3 sesiones/semana)",
    "unidad":"%",
    "template": "SELECT (SUM(CASE WHEN s.KT_FINAL > 40 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(DISTINCT x.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN JOIN ( SELECT p.NREGGEN, EXTRACT(YEAR FROM s.FECHA) AS ANIO, EXTRACT(WEEK FROM s.FECHA) AS SEMANA FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.SEXO = 'M' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY p.NREGGEN, EXTRACT(YEAR FROM s.FECHA), EXTRACT(WEEK FROM s.FECHA) HAVING COUNT(s.NSESION) = 3 ) x ON x.NREGGEN = s.NREGGEN AND EXTRACT(YEAR FROM s.FECHA) = x.ANIO AND EXTRACT(WEEK FROM s.FECHA) = x.SEMANA WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND p.SEXO = 'M' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "22QO7RXQ",
    "categoria": "Calidad Técnica ( Adecuación de HD)",
    "indicador": "Porcentaje de sesiones de HD  con  KT > 45 en varones(Con relación al total - se incluyen solo pacientes con 3 sesiones/semana)",
    "unidad":"%",
    "template": "SELECT (SUM(CASE WHEN p.SEXO = 'H' AND s.KT_FINAL > 45 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(DISTINCT x.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN JOIN ( SELECT p.NREGGEN, EXTRACT(YEAR FROM s.FECHA) AS ANIO, EXTRACT(WEEK FROM s.FECHA) AS SEMANA FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY p.NREGGEN, EXTRACT(YEAR FROM s.FECHA), EXTRACT(WEEK FROM s.FECHA) HAVING COUNT(s.NSESION) = 3 ) x ON x.NREGGEN = s.NREGGEN AND EXTRACT(YEAR FROM s.FECHA) = x.ANIO AND EXTRACT(WEEK FROM s.FECHA) = x.SEMANA WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "22QO2TXQ",
    "categoria": "Calidad Técnica ( Adecuación de HD)",
    "indicador": "Porcentaje de sesiones de HD  con  KT > 40 en mujeres (Con relación al total - se incluyen solo pacientes con 3 sesiones/semana)",
    "unidad":"%",
    "template": "SELECT (SUM(CASE WHEN p.SEXO = 'M' AND s.KT_FINAL > 40 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(DISTINCT x.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN JOIN ( SELECT p.NREGGEN, EXTRACT(YEAR FROM s.FECHA) AS ANIO, EXTRACT(WEEK FROM s.FECHA) AS SEMANA FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY p.NREGGEN, EXTRACT(YEAR FROM s.FECHA), EXTRACT(WEEK FROM s.FECHA) HAVING COUNT(s.NSESION) = 3 ) x ON x.NREGGEN = s.NREGGEN AND EXTRACT(YEAR FROM s.FECHA) = x.ANIO AND EXTRACT(WEEK FROM s.FECHA) = x.SEMANA WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "A5T4GJWU",
    "categoria": "Calidad Técnica ( Adecuación de HD)",
    "indicador": "Porcentaje de sesiones de HD  con  KT semanal > 135 ( se incluyen solo pacientes con 3 o mas sesiones/semana)",
    "unidad":"%",
    "template": "WITH Semanas AS ( SELECT p.NREGGEN, EXTRACT(YEAR FROM s.FECHA) AS ANIO, EXTRACT(WEEK FROM s.FECHA) AS SEMANA, COUNT(s.NSESION) AS sesiones_semana, SUM(s.KT_FINAL) AS kt_semanal FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY p.NREGGEN, EXTRACT(YEAR FROM s.FECHA), EXTRACT(WEEK FROM s.FECHA) HAVING COUNT(s.NSESION) >= 3 ) SELECT (SUM(CASE WHEN kt_semanal > 135 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(DISTINCT NREGGEN) AS numero_pacientes FROM Semanas;"
  },
  {
    "id_code": "2YZ1TLG8",
    "categoria": "Calidad Técnica ( Adecuación de HD)",
    "indicador": "Porcentaje de sesiones de HD  con  KT > 45 ( se incluyen solo pacientes con 3 o mas sesiones/semana )",
    "unidad":"%",
    "template": "SELECT (SUM(CASE WHEN s.KT_FINAL > 45 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(DISTINCT x.NREGGEN) AS numero_pacientes FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN JOIN ( SELECT p.NREGGEN, EXTRACT(YEAR FROM s.FECHA) AS ANIO, EXTRACT(WEEK FROM s.FECHA) AS SEMANA FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY p.NREGGEN, EXTRACT(YEAR FROM s.FECHA), EXTRACT(WEEK FROM s.FECHA) HAVING COUNT(s.NSESION) >= 3 ) x ON x.NREGGEN = s.NREGGEN AND EXTRACT(YEAR FROM s.FECHA) = x.ANIO AND EXTRACT(WEEK FROM s.FECHA) = x.SEMANA WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN;"
  },
  {
    "id_code": "6Q2L9AVX",
    "categoria": "Calidad Técnica (Anemia)",
    "indicador": "Porcentaje de pacientes prevalentes con más de 3 meses en HD con hemoglobina media del periodo > 10,5 g/dl",
    "unidad":"%",
    "template": "WITH PrevHD AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAINI AS DATE)) AND COALESCE(p.DESPLAZADO, 0) = 0 ), HbMediaPeriodo AS ( SELECT a.NREGGEN, AVG(CAST(r.VALOR AS DECIMAL(9,2))) AS HB_MEDIA FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PrevHD ph ON ph.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('HEMOG','HGB', 'Hb') AND r.VALOR IS NOT NULL AND CAST(r.VALOR AS DECIMAL(9,2)) > 0 GROUP BY a.NREGGEN ) SELECT (SUM(CASE WHEN HB_MEDIA > 10.5 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(*) AS numero_pacientes FROM HbMediaPeriodo;"
  }
  ,
  {
    "id_code": "ROE5HY95",
    "categoria": "Calidad Técnica ( Anemia)",
    "indicador": "Porcentaje de pacientes prevalentes con más de 3 meses en HD (no desplazados) con hemoglobina media del periodo seleccionado > 10,5 g/dl y < 12,5 g/dl",
    "unidad":"%",
    "template": "WITH PrevHD AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAINI AS DATE)) AND COALESCE(p.DESPLAZADO, 0) = 0 ), HbMediaPeriodo AS ( SELECT a.NREGGEN, AVG(CAST(r.VALOR AS DECIMAL(9,2))) AS HB_MEDIA FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PrevHD ph ON ph.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('HEMOG','HGB', 'Hb') AND r.VALOR IS NOT NULL AND CAST(r.VALOR AS DECIMAL(9,2)) > 0 GROUP BY a.NREGGEN ) SELECT (SUM(CASE WHEN HB_MEDIA > 10.5 AND HB_MEDIA < 12.5 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(*) AS numero_pacientes FROM HbMediaPeriodo;"
  },
  

  {
    "id_code": "YAWSWESG",
    "categoria": "Calidad Técnica ( Anemia)",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD (no desplazados) en tratamiento con Eritropoyetina con  hemoglobina >  12,5 g/dl ( suma de todos los pacientes  con mas de 3 meses en HD en tratamiento con Eritropoyetina con  hemoglobina >  12,5 g/dl / nº total de pacientes con mas de 3 meses de HD en el periodo) ",
    "unidad":"%",
    "template": "WITH PacientesHD AS ( SELECT p.NREGGEN FROM PACIENTES p WHERE p.FECH_INICIO_CENTRO <= DATEADD(-90 DAY TO :FECHAFIN) ) , UltimaFecha AS ( SELECT a.NREGGEN, MAX(a.FECHA) AS FECHA FROM ANALISIS a WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND a.NREGGEN IN (SELECT NREGGEN FROM PacientesHD) GROUP BY a.NREGGEN ) , UltimaAnalitica AS ( SELECT a.NREGGEN, r.VALOR AS HEMOGLOBINA FROM ANALISIS a JOIN UltimaFecha uf ON a.NREGGEN = uf.NREGGEN AND a.FECHA = uf.FECHA JOIN RESULANAL r ON a.NUMANALISIS = r.ANALISIS WHERE r.CODANAL = 'HEMOG' ) , PautaEPO AS ( SELECT DISTINCT pa.NREGGEN FROM PAUTA pa WHERE pa.EPOHD > 0 ) SELECT (CAST(COUNT(DISTINCT CASE WHEN u.HEMOGLOBINA > 12.5 AND pe.NREGGEN IS NOT NULL THEN ph.NREGGEN END) AS FLOAT) / NULLIF(COUNT(DISTINCT ph.NREGGEN),0)) * 100 AS PORCENTAJE_EPO_HB_ALTA FROM PacientesHD ph LEFT JOIN UltimaAnalitica u ON ph.NREGGEN = u.NREGGEN LEFT JOIN PautaEPO pe ON ph.NREGGEN = pe.NREGGEN;"
  },
  {
    "id_code": "NB5L25G8",
    "categoria": "Calidad Técnica ( Anemia)",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD (no desplazados) con ferritina < 150 g/dl (suma de todos los pacientes con mas de 3 meses en HD con ferritina < 150 g/dl / nº total de pacientes con mas de 3 meses de HD en el periodo)",
    "unidad": "%",
    "template": "WITH PrevHD AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAINI AS DATE)) AND COALESCE(p.DESPLAZADO, 0) = 0 ), FerrMediaPeriodo AS ( SELECT a.NREGGEN, AVG(CAST(REPLACE(r.VALOR, ',', '.') AS DECIMAL(18,4))) AS FERR_MEDIA FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PrevHD ph ON ph.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('FERRIT','FERRITINA') AND r.VALOR IS NOT NULL AND NULLIF(TRIM(r.VALOR), '') IS NOT NULL AND CAST(REPLACE(r.VALOR, ',', '.') AS DECIMAL(18,4)) > 0 GROUP BY a.NREGGEN ) SELECT (SUM(CASE WHEN FERR_MEDIA < 150 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(*) AS numero_pacientes FROM FerrMediaPeriodo;"
  },
  {
    "id_code": "ZGUI0PT1",
    "categoria": "Calidad Técnica ( Anemia)",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD con ferritina entre 150 y 800 g/dl (suma de todos los pacientes con mas de 3 meses en HD con ferritina entre 150 y 800 g/dl / nº total de pacientes con mas de 3 meses de HD en el periodo)",
    "unidad": "%",
    "template": "WITH PrevHD AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAINI AS DATE)) AND COALESCE(p.DESPLAZADO, 0) = 0 ), FerrMediaPeriodo AS ( SELECT a.NREGGEN, AVG(CAST(REPLACE(r.VALOR, ',', '.') AS DECIMAL(18,4))) AS FERR_MEDIA FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PrevHD ph ON ph.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('FERRIT','FERRITINA') AND r.VALOR IS NOT NULL AND NULLIF(TRIM(r.VALOR), '') IS NOT NULL AND CAST(REPLACE(r.VALOR, ',', '.') AS DECIMAL(18,4)) > 0 GROUP BY a.NREGGEN ) SELECT (SUM(CASE WHEN FERR_MEDIA >= 150 AND FERR_MEDIA <= 800 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(*) AS numero_pacientes FROM FerrMediaPeriodo;"
  },
  {
    "id_code": "1YSSX8Y1",
    "categoria": "Calidad Técnica ( Anemia)",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD con IST < 20 % (suma de todos los pacientes con mas de 3 meses en HD con IST < 20 % / nº total de pacientes con mas de 3 meses de HD en el periodo)",
    "unidad": "%",
    "template": "WITH PrevHD AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAINI AS DATE)) AND COALESCE(p.DESPLAZADO, 0) = 0 ), ISTMediaPeriodo AS ( SELECT a.NREGGEN, AVG(CAST(REPLACE(r.VALOR, ',', '.') AS DECIMAL(18,4))) AS IST_MEDIA FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PrevHD ph ON ph.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('IST','TSAT','SAT_TRANSF','SATTRANSF') AND r.VALOR IS NOT NULL AND NULLIF(TRIM(r.VALOR), '') IS NOT NULL AND CAST(REPLACE(r.VALOR, ',', '.') AS DECIMAL(18,4)) > 0 GROUP BY a.NREGGEN ) SELECT (SUM(CASE WHEN IST_MEDIA < 20 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS resultado, COUNT(*) AS numero_pacientes FROM ISTMediaPeriodo;"
  },
  
  

  {
    "id_code": "UMEGZZHA",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con fósforo < 3,5 g/dl CON tratamiento con Captores del fosforo  ",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), FOSFORO_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS FOSFORO_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('FOSFORO','P') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM FOSFORO_PERIODO), PAC_CON_CAPTOR_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_CAPTORES) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_FOSFORO AS (SELECT f.NREGGEN, AVG(f.FOSFORO_VAL) AS FOSFORO_MEDIA FROM FOSFORO_PERIODO f GROUP BY f.NREGGEN), NUMERADOR AS (SELECT pf.NREGGEN FROM PROMEDIO_FOSFORO pf JOIN EVALUABLES e ON e.NREGGEN = pf.NREGGEN JOIN PAC_CON_CAPTOR_PERIODO pc ON pc.NREGGEN = pf.NREGGEN WHERE pf.FOSFORO_MEDIA < 3.5) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  } 
,  

  {
    "id_code": "A05OFDE8",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con fósforo < 3,5 g/dl SIN  tratamiento con Captores del fosforo ",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), FOSFORO_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS FOSFORO_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('FOSFORO','P') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM FOSFORO_PERIODO), PAC_CON_CAPTOR_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_CAPTORES) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_FOSFORO AS (SELECT f.NREGGEN, AVG(f.FOSFORO_VAL) AS FOSFORO_MEDIA FROM FOSFORO_PERIODO f GROUP BY f.NREGGEN), NUMERADOR AS (SELECT pf.NREGGEN FROM PROMEDIO_FOSFORO pf JOIN EVALUABLES e ON e.NREGGEN = pf.NREGGEN LEFT JOIN PAC_CON_CAPTOR_PERIODO pc ON pc.NREGGEN = pf.NREGGEN WHERE pc.NREGGEN IS NULL AND pf.FOSFORO_MEDIA < 3.5) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "KPPHSAG8",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con fósforo entre 3,5  y 5,5 g/dl CON tratamiento con Captores del fosforo",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), FOSFORO_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS FOSFORO_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('FOSFORO','P') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM FOSFORO_PERIODO), PAC_CON_CAPTOR_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_CAPTORES) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_FOSFORO AS (SELECT f.NREGGEN, AVG(f.FOSFORO_VAL) AS FOSFORO_MEDIA FROM FOSFORO_PERIODO f GROUP BY f.NREGGEN), NUMERADOR AS (SELECT pf.NREGGEN FROM PROMEDIO_FOSFORO pf JOIN EVALUABLES e ON e.NREGGEN = pf.NREGGEN JOIN PAC_CON_CAPTOR_PERIODO pc ON pc.NREGGEN = pf.NREGGEN WHERE pf.FOSFORO_MEDIA >= 3.5 AND pf.FOSFORO_MEDIA <= 5.5) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "KW8PLPSC",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con fósforo entre 3,5  y  5,5 g/dl SIN  tratamiento con Captores del fosforo  ",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), FOSFORO_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS FOSFORO_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('FOSFORO','P') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM FOSFORO_PERIODO), PAC_CON_CAPTOR_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_CAPTORES) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_FOSFORO AS (SELECT f.NREGGEN, AVG(f.FOSFORO_VAL) AS FOSFORO_MEDIA FROM FOSFORO_PERIODO f GROUP BY f.NREGGEN), NUMERADOR AS (SELECT pf.NREGGEN FROM PROMEDIO_FOSFORO pf JOIN EVALUABLES e ON e.NREGGEN = pf.NREGGEN LEFT JOIN PAC_CON_CAPTOR_PERIODO pc ON pc.NREGGEN = pf.NREGGEN WHERE pc.NREGGEN IS NULL AND pf.FOSFORO_MEDIA >= 3.5 AND pf.FOSFORO_MEDIA <= 5.5) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "XMDJNY2T",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con fósforo > 5,5 g/dl CON  tratamiento con Captores del fosforo ",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), FOSFORO_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS FOSFORO_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('FOSFORO','P') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM FOSFORO_PERIODO), PAC_CON_CAPTOR_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_CAPTORES) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_FOSFORO AS (SELECT f.NREGGEN, AVG(f.FOSFORO_VAL) AS FOSFORO_MEDIA FROM FOSFORO_PERIODO f GROUP BY f.NREGGEN), NUMERADOR AS (SELECT pf.NREGGEN FROM PROMEDIO_FOSFORO pf JOIN EVALUABLES e ON e.NREGGEN = pf.NREGGEN JOIN PAC_CON_CAPTOR_PERIODO pc ON pc.NREGGEN = pf.NREGGEN WHERE pf.FOSFORO_MEDIA > 5.5) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "P8NMB54F",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con fósforo > 5,5 g/dl SIN  tratamiento con Captores del fosforo ",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), FOSFORO_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS FOSFORO_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('FOSFORO','P') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM FOSFORO_PERIODO), PAC_CON_CAPTOR_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_CAPTORES) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_FOSFORO AS (SELECT f.NREGGEN, AVG(f.FOSFORO_VAL) AS FOSFORO_MEDIA FROM FOSFORO_PERIODO f GROUP BY f.NREGGEN), NUMERADOR AS (SELECT pf.NREGGEN FROM PROMEDIO_FOSFORO pf JOIN EVALUABLES e ON e.NREGGEN = pf.NREGGEN LEFT JOIN PAC_CON_CAPTOR_PERIODO pc ON pc.NREGGEN = pf.NREGGEN WHERE pc.NREGGEN IS NULL AND pf.FOSFORO_MEDIA > 5.5) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "8Y3A3HUY",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con PTH < 150 pg/ml CON tratamiento con vitamina D y/o calcimimeticos ",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), PTH_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS PTH_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('PTH-I', 'PTH', 'PTHI') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM PTH_PERIODO), PAC_CON_TTO_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_VITD_CALCIMIM) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_PTH AS (SELECT x.NREGGEN, AVG(x.PTH_VAL) AS PTH_MEDIA FROM PTH_PERIODO x GROUP BY x.NREGGEN), NUMERADOR AS (SELECT p.NREGGEN FROM PROMEDIO_PTH p JOIN EVALUABLES e ON e.NREGGEN = p.NREGGEN JOIN PAC_CON_TTO_PERIODO tt ON tt.NREGGEN = p.NREGGEN WHERE p.PTH_MEDIA < 150) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "RI0HVJ1D",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con PTH < 150 pg/ml SIN  tratamiento con vitamina D y/o calcimimeticos ",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), PTH_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS PTH_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('PTH-I', 'PTH', 'PTHI') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM PTH_PERIODO), PAC_CON_TTO_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_VITD_CALCIMIM) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_PTH AS (SELECT x.NREGGEN, AVG(x.PTH_VAL) AS PTH_MEDIA FROM PTH_PERIODO x GROUP BY x.NREGGEN), NUMERADOR AS (SELECT p.NREGGEN FROM PROMEDIO_PTH p JOIN EVALUABLES e ON e.NREGGEN = p.NREGGEN LEFT JOIN PAC_CON_TTO_PERIODO tt ON tt.NREGGEN = p.NREGGEN WHERE tt.NREGGEN IS NULL AND p.PTH_MEDIA < 150) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "FIC40IPV",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con PTH entre 150 y 500 pg/ml CON tratamiento con tratamiento con vitamina D y/o calcimimeticos ",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), PTH_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS PTH_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('PTH-I', 'PTH', 'PTHI') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM PTH_PERIODO), PAC_CON_TTO_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_VITD_CALCIMIM) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_PTH AS (SELECT x.NREGGEN, AVG(x.PTH_VAL) AS PTH_MEDIA FROM PTH_PERIODO x GROUP BY x.NREGGEN), NUMERADOR AS (SELECT p.NREGGEN FROM PROMEDIO_PTH p JOIN EVALUABLES e ON e.NREGGEN = p.NREGGEN JOIN PAC_CON_TTO_PERIODO tt ON tt.NREGGEN = p.NREGGEN WHERE p.PTH_MEDIA >= 150 AND p.PTH_MEDIA <= 500) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "E403U8WB",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con PTH entre 150 y 500 pg/ml SIN tratamiento con vitamina D y/o calcimimeticos",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), PTH_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS PTH_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('PTH-I', 'PTH', 'PTHI') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM PTH_PERIODO), PAC_CON_TTO_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_VITD_CALCIMIM) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_PTH AS (SELECT x.NREGGEN, AVG(x.PTH_VAL) AS PTH_MEDIA FROM PTH_PERIODO x GROUP BY x.NREGGEN), NUMERADOR AS (SELECT p.NREGGEN FROM PROMEDIO_PTH p JOIN EVALUABLES e ON e.NREGGEN = p.NREGGEN LEFT JOIN PAC_CON_TTO_PERIODO tt ON tt.NREGGEN = p.NREGGEN WHERE tt.NREGGEN IS NULL AND p.PTH_MEDIA >= 150 AND p.PTH_MEDIA <= 500) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "5HN6MNIH",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con PTH > 500 pg/ml CON tratamiento con vitamina D y/o calcimimeticos",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), PTH_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS PTH_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('PTH-I', 'PTH', 'PTHI') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM PTH_PERIODO), PAC_CON_TTO_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_VITD_CALCIMIM) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_PTH AS (SELECT x.NREGGEN, AVG(x.PTH_VAL) AS PTH_MEDIA FROM PTH_PERIODO x GROUP BY x.NREGGEN), NUMERADOR AS (SELECT p.NREGGEN FROM PROMEDIO_PTH p JOIN EVALUABLES e ON e.NREGGEN = p.NREGGEN JOIN PAC_CON_TTO_PERIODO tt ON tt.NREGGEN = p.NREGGEN WHERE p.PTH_MEDIA > 500) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "7NTG37MC",
    "categoria": "Calidad Técnica ( metabolismo mineral )",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con PTH > 500 pg/ml SIN tratamiento con vitamina D y/o calcimimeticos",
    "unidad":"%",
    "template": "WITH PREVALENTES AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_3M AS (SELECT pr.NREGGEN FROM PREVALENTES pr JOIN PACIENTES p ON p.NREGGEN = pr.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, CAST(:FECHAFIN AS DATE))), PTH_PERIODO AS (SELECT a.NREGGEN, CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(10,2)) AS PTH_VAL FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PREVALENTES_3M p3 ON p3.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('PTH-I', 'PTH', 'PTHI') AND r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> ''), EVALUABLES AS (SELECT DISTINCT NREGGEN FROM PTH_PERIODO), PAC_CON_TTO_PERIODO AS (SELECT DISTINCT t.NREGGEN FROM TRATAMIENT_ACTUAL t JOIN PREVALENTES_3M p3 ON p3.NREGGEN = t.NREGGEN WHERE UPPER(TRIM(t.TRATAMIENTO)) IN (:CODIGOS_VITD_CALCIMIM) AND t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAINI)), PROMEDIO_PTH AS (SELECT x.NREGGEN, AVG(x.PTH_VAL) AS PTH_MEDIA FROM PTH_PERIODO x GROUP BY x.NREGGEN), NUMERADOR AS (SELECT p.NREGGEN FROM PROMEDIO_PTH p JOIN EVALUABLES e ON e.NREGGEN = p.NREGGEN LEFT JOIN PAC_CON_TTO_PERIODO tt ON tt.NREGGEN = p.NREGGEN WHERE tt.NREGGEN IS NULL AND p.PTH_MEDIA > 500) SELECT CAST(COUNT(DISTINCT n.NREGGEN) * 100.0 / NULLIF((SELECT COUNT(*) FROM PREVALENTES_3M), 0) AS NUMERIC(10,2)) AS resultado, (SELECT COUNT(*) FROM PREVALENTES_3M) AS numero_pacientes, (SELECT COUNT(*) FROM EVALUABLES) AS evaluables, ((SELECT COUNT(*) FROM PREVALENTES_3M) - (SELECT COUNT(*) FROM EVALUABLES)) AS no_evaluables FROM NUMERADOR n;"
  },
  {
    "id_code": "VOQH6OQC",
    "categoria": "Calidad Técnica ( nutricion)",
    "indicador": "Porcentaje de pacientes prevalentes con mas de 3 meses en HD  con albumina > 3,5 g/dl    ",
    "unidad":"%",
    "template": "WITH PrevHD AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND p.FECH_INICIO_CENTRO <= DATEADD(DAY, -90, :FECHAFIN) AND COALESCE(p.DESPLAZADO, 0) = 0), AlbMediaPeriodo AS (SELECT a.NREGGEN, AVG(CASE WHEN r.VALOR IS NOT NULL AND TRIM(r.VALOR) <> '' AND TRIM(r.VALOR) NOT LIKE '%[^0-9,.-]%' AND TRIM(r.VALOR) NOT LIKE '%,%,%' AND TRIM(r.VALOR) NOT LIKE '%.%.%' THEN CAST(REPLACE(TRIM(r.VALOR), ',', '.') AS NUMERIC(18,4)) ELSE NULL END) AS ALB_MEDIA FROM ANALISIS a JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS JOIN PrevHD ph ON ph.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND r.CODANAL IN ('ALBUMINA','ALB') GROUP BY a.NREGGEN) SELECT CAST((SUM(CASE WHEN ALB_MEDIA > 3.5 THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS NUMERIC(10,2)) AS resultado, COUNT(*) AS numero_pacientes FROM AlbMediaPeriodo WHERE ALB_MEDIA IS NOT NULL;"
  },
  {
    "id_code": "IKX387MS",
    "categoria": "Calidad Técnica (acceso vascular)",
    "indicador": "Porcentaje de pacientes incidentes con cateter",
    "unidad":"%",
    "template": "WITH NUEVOS_EN_PERIODO AS ( SELECT DISTINCT p.NREGGEN, p.FECH_INICIO_CENTRO FROM PACIENTES p WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN ), ACCESO_INICIO AS ( SELECT n.NREGGEN, ra.TIPOACCESO FROM NUEVOS_EN_PERIODO n JOIN REG_ACCESOVAS ra ON ra.NREGGEN = n.NREGGEN WHERE COALESCE(ra.FECHAPUNCION, ra.FECHAREG) = ( SELECT MAX(COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN = n.NREGGEN AND COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG) <= n.FECH_INICIO_CENTRO AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN >= n.FECH_INICIO_CENTRO) ) AND (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= n.FECH_INICIO_CENTRO) ) SELECT CAST(CASE WHEN COUNT(ai.NREGGEN) = 0 THEN 0 ELSE (SUM(CASE WHEN ai.TIPOACCESO IN (<CODIGOS_CATETER>) THEN 1 ELSE 0 END) * 100.0 / COUNT(ai.NREGGEN)) END AS NUMERIC(10,2)) AS resultado, COUNT(ai.NREGGEN) AS numero_pacientes FROM NUEVOS_EN_PERIODO n LEFT JOIN ACCESO_INICIO ai ON ai.NREGGEN = n.NREGGEN;"
  },
  {
    "id_code": "FC8IYBZY",
    "categoria": "Calidad Técnica ( acceso vascular)",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo con cateter (suma de pacientes con cateter activo el ultimo dia / nº total de pacientes prevalentes ultimo dia)",
    "unidad":"%",
    "template": "WITH PREVALENTES_ULT_DIA AS (SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN=p.NREGGEN WHERE COALESCE(p.DESPLAZADO,0)=0 AND s.FECHA BETWEEN :FECHAINI_CALCULADA AND :FECHAFIN AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA=i.CAUSABAJA AND cb.TIPO='B' WHERE i.NREGGEN=p.NREGGEN AND i.FECHAINI<=:FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN>=:FECHAFIN))), ACCESO_ULT_DIA AS (SELECT DISTINCT pu.NREGGEN, ra.TIPOACCESO FROM PREVALENTES_ULT_DIA pu JOIN REG_ACCESOVAS ra ON ra.NREGGEN=pu.NREGGEN WHERE COALESCE(ra.FECHAPUNCION,ra.FECHAREG)=(SELECT MAX(COALESCE(ra2.FECHAPUNCION,ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN=pu.NREGGEN AND COALESCE(ra2.FECHAPUNCION,ra2.FECHAREG)<=:FECHAFIN AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN>=:FECHAFIN)) AND (ra.FECHAFIN IS NULL OR ra.FECHAFIN>=:FECHAFIN)) SELECT CAST(CASE WHEN COUNT(*)=0 THEN 0 ELSE (SUM(CASE WHEN au.TIPOACCESO IN (<CODIGOS_FAV_PROTESIS>) THEN 1 ELSE 0 END)*100.0/COUNT(*)) END AS NUMERIC(10,2)) AS resultado, COUNT(*) AS numero_pacientes FROM PREVALENTES_ULT_DIA pu LEFT JOIN ACCESO_ULT_DIA au ON au.NREGGEN=pu.NREGGEN;"
  },
  {
    "id_code": "QOATG1F3",
    "categoria": "Calidad Técnica ( acceso vascular)",
    "indicador": "Porcentaje de pacientes incidentes en periodo con FAV o protesis ( suma de todos los pacientes  nuevos con  FAV o protesis  desde el inicio del periodo hasta el final del periodo / nº total de pacientes nuevos en periodo) ",
    "unidad":"%",
    "template": "WITH NUEVOS_EN_PERIODO AS (SELECT DISTINCT p.NREGGEN, p.FECH_INICIO_CENTRO FROM PACIENTES p WHERE COALESCE(p.DESPLAZADO,0)=0 AND p.FECH_INICIO_CENTRO BETWEEN :FECHAINI AND :FECHAFIN), ACCESO_PREVIO AS (SELECT n.NREGGEN, ra.TIPOACCESO FROM NUEVOS_EN_PERIODO n JOIN REG_ACCESOVAS ra ON ra.NREGGEN=n.NREGGEN WHERE COALESCE(ra.FECHAPUNCION,ra.FECHAREG)=(SELECT MAX(COALESCE(ra2.FECHAPUNCION,ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN=n.NREGGEN AND COALESCE(ra2.FECHAPUNCION,ra2.FECHAREG)<n.FECH_INICIO_CENTRO AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN>=n.FECH_INICIO_CENTRO)) AND (ra.FECHAFIN IS NULL OR ra.FECHAFIN>=n.FECH_INICIO_CENTRO)) SELECT CAST(CASE WHEN COUNT(*)=0 THEN 0 ELSE (SUM(CASE WHEN ap.TIPOACCESO IN (<CODIGOS_FAV_PROTESIS>) THEN 1 ELSE 0 END)*100.0/COUNT(*)) END AS NUMERIC(10,2)) AS resultado, COUNT(*) AS numero_pacientes FROM NUEVOS_EN_PERIODO n LEFT JOIN ACCESO_PREVIO ap ON ap.NREGGEN=n.NREGGEN;"
  },
  {
    "id_code": "PC20TVDP",
    "categoria": "Calidad Técnica ( acceso vascular)",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo con FAV o protesis (fotografía a FECHAFIN: acceso vigente el último día / total prevalentes último día)",
    "unidad":"%",
    "template": "WITH PREVALENTES_ULT_DIA AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE  COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI_CALCULADA AND :FECHAFIN AND NOT EXISTS ( SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN) ) ), ACCESO_ULT_DIA AS ( SELECT pu.NREGGEN, ra.TIPOACCESO FROM PREVALENTES_ULT_DIA pu JOIN REG_ACCESOVAS ra ON ra.NREGGEN = pu.NREGGEN WHERE COALESCE(ra.FECHAPUNCION, ra.FECHAREG) = ( SELECT MAX(COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN = pu.NREGGEN AND COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG) <= :FECHAFIN AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN >= :FECHAFIN) ) AND (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= :FECHAFIN) ) SELECT CAST( CASE WHEN COUNT(*) = 0 THEN 0 ELSE ( SUM(CASE WHEN au.TIPOACCESO IN (<CODIGOS_FAV_PROTESIS>) THEN 1 ELSE 0 END) * 100.0 / COUNT(*) ) END AS NUMERIC(10,2) ) AS resultado, COUNT(*) AS numero_pacientes FROM PREVALENTES_ULT_DIA pu LEFT JOIN ACCESO_ULT_DIA au ON au.NREGGEN = pu.NREGGEN;"
  },
  
  {
    "id_code": "9GEH4F3B",
    "categoria": "Calidad Técnica ( acceso vascular)",
    "indicador": " Suma de incidencias de infecciones de FAV Autólogas (fistula) en periodo",
    "unidad":"%",
    "template": "WITH INFECCIONES_PERIODO AS ( SELECT v.NREGGEN, v.FECHAINCIDEN AS FECHA_INFECC FROM INCID_VASCU v WHERE v.FECHAINCIDEN BETWEEN :FECHAINI AND :FECHAFIN AND v.TIPOINCIDEN = 10 ), INFECCIONES_VALIDAS AS ( SELECT ip.NREGGEN, ip.FECHA_INFECC FROM INFECCIONES_PERIODO ip JOIN PACIENTES p ON p.NREGGEN = ip.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 ), ACCESO_EN_FECHA AS ( SELECT iv.NREGGEN, iv.FECHA_INFECC, ra.TIPOACCESO FROM INFECCIONES_VALIDAS iv JOIN REG_ACCESOVAS ra ON ra.NREGGEN = iv.NREGGEN AND COALESCE(ra.FECHAPUNCION, ra.FECHAREG) = ( SELECT MAX(COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN = iv.NREGGEN AND COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG) <= iv.FECHA_INFECC AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN >= iv.FECHA_INFECC) ) WHERE (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= iv.FECHA_INFECC) ) SELECT COUNT(*) AS resultado, COUNT(DISTINCT aef.NREGGEN) AS numero_pacientes FROM ACCESO_EN_FECHA aef WHERE aef.TIPOACCESO IN (<CODIGOS_FAV_AUTOLOGA>);"
  },
  
  {
    "id_code": "3FIH2AQG",
    "categoria": "Calidad Técnica ( acceso vascular)",
    "indicador": "Suma de incidencias de infecciones de FAV Prótesis en periodo",
    "unidad":"%",
    "template": "WITH INFECCIONES_PERIODO AS ( SELECT v.NREGGEN, v.FECHAINCIDEN AS FECHA_INFECC FROM INCID_VASCU v WHERE v.FECHAINCIDEN BETWEEN :FECHAINI AND :FECHAFIN AND v.TIPOINCIDEN = 10 ), INFECCIONES_VALIDAS AS ( SELECT ip.NREGGEN, ip.FECHA_INFECC FROM INFECCIONES_PERIODO ip JOIN PACIENTES p ON p.NREGGEN = ip.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 ), ACCESO_EN_FECHA AS ( SELECT iv.NREGGEN, iv.FECHA_INFECC, ra.TIPOACCESO FROM INFECCIONES_VALIDAS iv JOIN REG_ACCESOVAS ra ON ra.NREGGEN = iv.NREGGEN AND COALESCE(ra.FECHAPUNCION, ra.FECHAREG) = ( SELECT MAX(COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN = iv.NREGGEN AND COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG) <= iv.FECHA_INFECC AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN >= iv.FECHA_INFECC) ) WHERE (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= iv.FECHA_INFECC) ) SELECT COUNT(*) AS resultado, COUNT(DISTINCT aef.NREGGEN) AS numero_pacientes FROM ACCESO_EN_FECHA aef WHERE aef.TIPOACCESO IN (<CODIGOS_PROTESIS>);"
},
{
  "id_code": "FZ28T4BD",
  "categoria": "Calidad Técnica ( acceso vascular)",
  "indicador": " Suma de incidencias de infecciones en orificio o túnel del acceso del catéter tunelizado",
  "unidad":"%",
  "template": "WITH INFECCIONES_PERIODO AS ( SELECT v.NREGGEN, v.FECHAINCIDEN AS FECHA_INFECC FROM INCID_VASCU v WHERE v.FECHAINCIDEN BETWEEN :FECHAINI AND :FECHAFIN AND v.TIPOINCIDEN = 14 ), INFECCIONES_VALIDAS AS ( SELECT ip.NREGGEN, ip.FECHA_INFECC FROM INFECCIONES_PERIODO ip JOIN PACIENTES p ON p.NREGGEN = ip.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 ), ACCESO_EN_FECHA AS ( SELECT iv.NREGGEN, iv.FECHA_INFECC, ra.TIPOACCESO FROM INFECCIONES_VALIDAS iv JOIN REG_ACCESOVAS ra ON ra.NREGGEN = iv.NREGGEN AND COALESCE(ra.FECHAPUNCION, ra.FECHAREG) = ( SELECT MAX(COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN = iv.NREGGEN AND COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG) <= iv.FECHA_INFECC AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN >= iv.FECHA_INFECC) ) WHERE (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= iv.FECHA_INFECC) ) SELECT COUNT(*) AS resultado, COUNT(DISTINCT aef.NREGGEN) AS numero_pacientes FROM ACCESO_EN_FECHA aef WHERE aef.TIPOACCESO IN (<CODIGOS_CATETER_TUNELIZADO>);"
},

{
  "id_code": "GKB4JSRD",
  "categoria": "Calidad Técnica ( acceso vascular)",
  "indicador": "Tasa (%) de trombosis en prótesis en periodo (sobre pacientes con prótesis vigente en el intervalo)",
  "unidad":"%",
  "template": "WITH EVENTOS_PERIODO AS ( SELECT v.NREGGEN, v.FECHAINCIDEN AS FECHA_EVT FROM INCID_VASCU v WHERE v.FECHAINCIDEN BETWEEN :FECHAINI AND :FECHAFIN AND v.TIPOINCIDEN = 7 ), EVENTOS_VALIDOS AS ( SELECT ep.NREGGEN, ep.FECHA_EVT FROM EVENTOS_PERIODO ep JOIN PACIENTES p ON p.NREGGEN = ep.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 ), ACCESO_EN_FECHA AS ( SELECT ev.NREGGEN, ev.FECHA_EVT, ra.TIPOACCESO FROM EVENTOS_VALIDOS ev JOIN REG_ACCESOVAS ra ON ra.NREGGEN = ev.NREGGEN AND COALESCE(ra.FECHAPUNCION, ra.FECHAREG) = ( SELECT MAX(COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN = ev.NREGGEN AND COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG) <= ev.FECHA_EVT AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN >= ev.FECHA_EVT) ) WHERE (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= ev.FECHA_EVT) ), PACIENTES_CON_EVENTO AS ( SELECT DISTINCT aef.NREGGEN FROM ACCESO_EN_FECHA aef WHERE aef.TIPOACCESO IN (<CODIGOS_PROTESIS>) ), PACIENTES_PROTESIS AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN REG_ACCESOVAS ra ON ra.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND ra.TIPOACCESO IN (<CODIGOS_PROTESIS>) AND COALESCE(ra.FECHAPUNCION, ra.FECHAREG) <= :FECHAFIN AND (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= :FECHAINI) ) SELECT ( (SELECT COUNT(*) FROM PACIENTES_CON_EVENTO) * 100.0 / NULLIF((SELECT COUNT(*) FROM PACIENTES_PROTESIS), 0) ) AS resultado, (SELECT COUNT(*) FROM PACIENTES_CON_EVENTO) AS numero_pacientes FROM RDB$DATABASE;"
},

{
  "id_code": "XWM8PJHJ",
  "categoria": "Calidad Técnica ( acceso vascular)",
  "indicador": "Tasa (%) de trombosis de FAV prótesis en periodo (sobre pacientes con prótesis vigente en el intervalo)",
  "unidad":"%",
  "template": "WITH TROMBOSIS_PERIODO AS ( SELECT v.NREGGEN, v.FECHAINCIDEN AS FECHA_EVT FROM INCID_VASCU v WHERE v.FECHAINCIDEN BETWEEN :FECHAINI AND :FECHAFIN AND v.TIPOINCIDEN = 7 ), TROMBOSIS_VALIDAS AS ( SELECT tp.NREGGEN, tp.FECHA_EVT FROM TROMBOSIS_PERIODO tp JOIN PACIENTES p ON p.NREGGEN = tp.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 ), ACCESO_EN_FECHA AS ( SELECT tv.NREGGEN, tv.FECHA_EVT, ra.TIPOACCESO FROM TROMBOSIS_VALIDAS tv JOIN REG_ACCESOVAS ra ON ra.NREGGEN = tv.NREGGEN AND COALESCE(ra.FECHAPUNCION, ra.FECHAREG) = ( SELECT MAX(COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG)) FROM REG_ACCESOVAS ra2 WHERE ra2.NREGGEN = tv.NREGGEN AND COALESCE(ra2.FECHAPUNCION, ra2.FECHAREG) <= tv.FECHA_EVT AND (ra2.FECHAFIN IS NULL OR ra2.FECHAFIN >= tv.FECHA_EVT) ) WHERE (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= tv.FECHA_EVT) ), PACIENTES_CON_EVENTO AS ( SELECT DISTINCT aef.NREGGEN FROM ACCESO_EN_FECHA aef WHERE aef.TIPOACCESO IN (<CODIGOS_PROTESIS>) ), PACIENTES_PROTESIS AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN REG_ACCESOVAS ra ON ra.NREGGEN = p.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO, 0) = 0 AND ra.TIPOACCESO IN (<CODIGOS_PROTESIS>) AND COALESCE(ra.FECHAPUNCION, ra.FECHAREG) <= :FECHAFIN AND (ra.FECHAFIN IS NULL OR ra.FECHAFIN >= :FECHAINI) ) SELECT ( (SELECT COUNT(*) FROM PACIENTES_CON_EVENTO) * 100.0 / NULLIF((SELECT COUNT(*) FROM PACIENTES_PROTESIS), 0) ) AS resultado, (SELECT COUNT(*) FROM PACIENTES_CON_EVENTO) AS numero_pacientes FROM RDB$DATABASE;"
},

{
  "id_code": "MKTIE05T",
  "categoria": "Calidad Técnica ( virus )",
  "indicador": "Tasa (%) de seroconversiones al VHC en pacientes en Hemofiltración no desplazados",
  "unidad":"%",
  "template": "WITH HDF_NO_DESPLAZADOS AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0  AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), ULT_NEG_ANTES AS ( SELECT m.NREGGEN, MAX(m.FECHA) AS FECHA_NEG FROM ANALI_MARVIR m WHERE m.FECHA < :FECHAINI AND m.AC_VIRUSC_ELISA = 'N' AND m.NREGGEN IN (SELECT NREGGEN FROM HDF_NO_DESPLAZADOS) GROUP BY m.NREGGEN ), PRIM_POS_PERIODO AS ( SELECT m.NREGGEN, MIN(m.FECHA) AS FECHA_POS FROM ANALI_MARVIR m WHERE m.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND m.AC_VIRUSC_ELISA = 'P' AND m.NREGGEN IN (SELECT NREGGEN FROM HDF_NO_DESPLAZADOS) GROUP BY m.NREGGEN ), SEROCONVERSIONES AS ( SELECT DISTINCT n.NREGGEN FROM ULT_NEG_ANTES n JOIN PRIM_POS_PERIODO p ON p.NREGGEN = n.NREGGEN ) SELECT ( (SELECT COUNT(*) FROM SEROCONVERSIONES) * 100.0 / NULLIF((SELECT COUNT(*) FROM HDF_NO_DESPLAZADOS), 0) ) AS resultado, (SELECT COUNT(*) FROM SEROCONVERSIONES) AS numero_pacientes FROM RDB$DATABASE;"
},

{
  "id_code": "71WRCDJP",
  "categoria": "Calidad Técnica ( virus )",
  "indicador": "Tasa (%) de seroconversiones de pacientes crónicos en hemodiálisis al VHB (sobre cohorte en periodo)",
  "unidad": "%",
  "template": "WITH HD_NO_DESPLAZADOS AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.MODAL_TRAT = 'H' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), HD_CRONICOS AS ( SELECT h.NREGGEN FROM HD_NO_DESPLAZADOS h JOIN PACIENTES p ON p.NREGGEN = h.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(-90 DAY TO :FECHAFIN) ), COHORTE_NEG_INI AS ( SELECT m.NREGGEN, MAX(m.FECHA) AS FECHA_NEG FROM ANALI_MARVIR m WHERE m.FECHA < :FECHAINI AND UPPER(TRIM(m.ANTIGENO_HBS)) = 'N' AND m.NREGGEN IN (SELECT NREGGEN FROM HD_CRONICOS) GROUP BY m.NREGGEN ), PRIM_POS_PERIODO AS ( SELECT m.NREGGEN, MIN(m.FECHA) AS FECHA_POS FROM ANALI_MARVIR m WHERE m.FECHA >= :FECHAINI AND m.FECHA < DATEADD(1 DAY TO :FECHAFIN) AND UPPER(TRIM(m.ANTIGENO_HBS)) = 'P' AND m.NREGGEN IN (SELECT NREGGEN FROM HD_CRONICOS) GROUP BY m.NREGGEN ), SEROCONVERSIONES AS ( SELECT DISTINCT c.NREGGEN FROM COHORTE_NEG_INI c JOIN PRIM_POS_PERIODO p ON p.NREGGEN = c.NREGGEN ) SELECT ( (SELECT COUNT(*) FROM SEROCONVERSIONES) * 100.0 / NULLIF((SELECT COUNT(*) FROM COHORTE_NEG_INI), 0) ) AS resultado, (SELECT COUNT(*) FROM SEROCONVERSIONES) AS numero_pacientes FROM RDB$DATABASE;"
},


{
  "id_code": "XR42E2NT",
  "categoria": "Calidad Técnica ( virus )",
  "indicador": "Tasa (%) de seroconversiones al VIH (sobre cohorte en periodo)",
  "unidad":"%",
  "template": "WITH HD_NO_DESPLAZADOS AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND p.MODAL_TRAT = 'H' AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ), HD_CRONICOS AS ( SELECT h.NREGGEN FROM HD_NO_DESPLAZADOS h JOIN PACIENTES p ON p.NREGGEN = h.NREGGEN WHERE p.FECH_INICIO_CENTRO <= DATEADD(-90 DAY TO :FECHAFIN) ), COHORTE_NEG_INI AS ( SELECT m.NREGGEN, MAX(m.FECHA) AS FECHA_NEG FROM ANALI_MARVIR m WHERE m.FECHA < :FECHAINI AND UPPER(TRIM(m.VIH)) = 'N' AND m.NREGGEN IN (SELECT NREGGEN FROM HD_CRONICOS) GROUP BY m.NREGGEN ), PRIM_POS_PERIODO AS ( SELECT m.NREGGEN, MIN(m.FECHA) AS FECHA_POS FROM ANALI_MARVIR m WHERE m.FECHA >= :FECHAINI AND m.FECHA < DATEADD(1 DAY TO :FECHAFIN) AND UPPER(TRIM(m.VIH)) = 'P' AND m.NREGGEN IN (SELECT NREGGEN FROM HD_CRONICOS) GROUP BY m.NREGGEN ), SEROCONVERSIONES AS ( SELECT DISTINCT c.NREGGEN FROM COHORTE_NEG_INI c JOIN PRIM_POS_PERIODO p ON p.NREGGEN = c.NREGGEN ) SELECT ( (SELECT COUNT(*) FROM SEROCONVERSIONES) * 100.0 / NULLIF((SELECT COUNT(*) FROM COHORTE_NEG_INI), 0) ) AS resultado, (SELECT COUNT(*) FROM SEROCONVERSIONES) AS numero_pacientes FROM RDB$DATABASE;"
},

{
  "id_code": "VE2Y7XZ8",
  "categoria": "Calidad Técnica",
  "indicador": "Tasa (%) de Mortalidad (Exitus) en periodo",
  "unidad":"%",
  "template": "SELECT (CAST(t1.NUM_FALLECIDOS AS FLOAT) * 100) / NULLIF(CAST(t2.NUM_PACIENTES_PREVALENTES AS FLOAT), 0) AS resultado, t2.NUM_PACIENTES_PREVALENTES AS numero_pacientes FROM ( SELECT COUNT(DISTINCT i.NREGGEN) AS NUM_FALLECIDOS FROM INCIDENCIAS i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO,0) = 0 AND i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND i.CAUSABAJA = 'E' ) t1 CROSS JOIN ( SELECT COUNT(DISTINCT p.NREGGEN) AS NUM_PACIENTES_PREVALENTES FROM PACIENTES p JOIN SESION s ON p.NREGGEN = s.NREGGEN WHERE p.MODAL_TRAT = 'H' AND COALESCE(p.DESPLAZADO,0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ) t2;"
},

  {
    "id_code": "LCBFUNKD",
    "categoria": "Medicacion ",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con EPO",
    "unidad":"%",
    "template": "WITH ULT_DIA_ACTIVIDAD AS (SELECT MAX(s.FECHA) AS FECHA_ULT_DIA FROM SESION s WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_ULT_DIA AS (SELECT DISTINCT s.NREGGEN FROM SESION s JOIN ULT_DIA_ACTIVIDAD u ON u.FECHA_ULT_DIA = s.FECHA JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN))), DENOM AS (SELECT COUNT(DISTINCT NREGGEN) AS n FROM PREVALENTES_ULT_DIA), NUM AS (SELECT COUNT(DISTINCT pr.NREGGEN) AS n FROM PREVALENTES_ULT_DIA pr JOIN TRATAMIENT_ACTUAL t ON t.NREGGEN = pr.NREGGEN WHERE t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAFIN) AND t.GRUPO IN (:CODIGOS_EPO)) SELECT CAST((CASE WHEN denom.n = 0 THEN 0 ELSE (num.n * 100.0) / denom.n END) AS NUMERIC(10,2)) AS resultado, denom.n AS numero_pacientes FROM num CROSS JOIN denom;"
  },
  {
    "id_code": "FVTWQKHQ",
    "categoria": "Medicacion ",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con vitamina D",
    "unidad":"%",
    "template": "WITH ULT_DIA_ACTIVIDAD AS (SELECT MAX(s.FECHA) AS FECHA_ULT_DIA FROM SESION s WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN), PREVALENTES_ULT_DIA AS (SELECT DISTINCT s.NREGGEN FROM SESION s JOIN ULT_DIA_ACTIVIDAD u ON u.FECHA_ULT_DIA = s.FECHA JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND NOT EXISTS (SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN))), DENOM AS (SELECT COUNT(DISTINCT NREGGEN) AS n FROM PREVALENTES_ULT_DIA), NUM AS (SELECT COUNT(DISTINCT pr.NREGGEN) AS n FROM PREVALENTES_ULT_DIA pr JOIN TRATAMIENT_ACTUAL t ON t.NREGGEN = pr.NREGGEN WHERE t.FECHAINI <= :FECHAFIN AND (t.FECHAFIN IS NULL OR t.FECHAFIN >= :FECHAFIN) AND t.GRUPO IN (:CODIGOS_VITAMINA_D)) SELECT CAST((CASE WHEN denom.n = 0 THEN 0 ELSE (num.n * 100.0) / denom.n END) AS NUMERIC(10,2)) AS resultado, denom.n AS numero_pacientes FROM num CROSS JOIN denom;"
  },
  {
    "id_code": "NYDQPQNH",
    "categoria": "Medicacion ",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con calcimimeticos",
    "unidad": "%",
    "template": "WITH PREVALENTES_ULT_DIA AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI_CALCULADA AND :FECHAFIN AND NOT EXISTS ( SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN) ) ), PACIENTES_TTO AS ( SELECT DISTINCT tas.NREGGEN FROM TRATAMIENT_ACTUAL tas JOIN PREVALENTES_ULT_DIA p ON p.NREGGEN = tas.NREGGEN WHERE UPPER(TRIM(tas.TRATAMIENTO)) IN (:CODIGOS_CALCIMIMETICOS) AND tas.FECHAINI <= :FECHAFIN AND (tas.FECHAFIN IS NULL OR tas.FECHAFIN >= :FECHAFIN) ) SELECT CAST(CASE WHEN COUNT(p.NREGGEN) = 0 THEN 0 ELSE (COUNT(DISTINCT pt.NREGGEN) * 100.0 / COUNT(DISTINCT p.NREGGEN)) END AS NUMERIC(10,2)) AS resultado, COUNT(DISTINCT pt.NREGGEN) AS numero_pacientes FROM PREVALENTES_ULT_DIA p LEFT JOIN PACIENTES_TTO pt ON pt.NREGGEN = p.NREGGEN;"
  },
  {
    "id_code": "VCI4Q80H",
    "categoria": "Medicacion ",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con captores de fosforo",
    "unidad":"%",
    "template": "WITH PREVALENTES_ULT_DIA AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND NOT EXISTS ( SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN) ) ), DENOM AS ( SELECT COUNT(DISTINCT NREGGEN) AS n FROM PREVALENTES_ULT_DIA ), NUM AS ( SELECT COUNT(DISTINCT ta.NREGGEN) AS n FROM TRATAMIENT_ACTUAL ta JOIN PREVALENTES_ULT_DIA pu ON pu.NREGGEN = ta.NREGGEN WHERE ta.FECHAINI <= :FECHAFIN AND (ta.FECHAFIN IS NULL OR ta.FECHAFIN >= :FECHAFIN) AND UPPER(TRIM(ta.TRATAMIENTO)) IN (<LISTA_CAPTORES_FOSFORO>) ) SELECT CAST(CASE WHEN d.n = 0 THEN 0 ELSE (n.n * 100.0) / d.n END AS NUMERIC(10,2)) AS resultado, d.n AS numero_pacientes, n.n AS numerador, d.n AS denominador FROM NUM n CROSS JOIN DENOM d;"
  },
  {
    "id_code": "37YWSM98",
    "categoria": "Medicacion ",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con captores de fosforo calcicos",
    "unidad":"%",
    "template": "WITH PREVALENTES_ULT_DIA AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND NOT EXISTS ( SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN) ) ), DENOM AS ( SELECT COUNT(DISTINCT NREGGEN) AS n FROM PREVALENTES_ULT_DIA ), NUM AS ( SELECT COUNT(DISTINCT ta.NREGGEN) AS n FROM TRATAMIENT_ACTUAL ta JOIN PREVALENTES_ULT_DIA pu ON pu.NREGGEN = ta.NREGGEN WHERE ta.FECHAINI <= :FECHAFIN AND (ta.FECHAFIN IS NULL OR ta.FECHAFIN >= :FECHAFIN) AND UPPER(TRIM(ta.TRATAMIENTO)) IN (<LISTA_CAPTORES_CALCICOS>) ) SELECT CAST(CASE WHEN d.n = 0 THEN 0 ELSE (n.n * 100.0) / d.n END AS NUMERIC(10,2)) AS resultado, d.n AS numero_pacientes, n.n AS numerador, d.n AS denominador FROM NUM n CROSS JOIN DENOM d;"
  },
  {
    "id_code": "NX2SXHHS",
    "categoria": "Medicacion ",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con captores de fosforo no calcicos",
    "unidad":"%",
    "template": "WITH PREVALENTES_ULT_DIA AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND NOT EXISTS ( SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN) ) ), DENOM AS ( SELECT COUNT(DISTINCT NREGGEN) AS n FROM PREVALENTES_ULT_DIA ), NUM AS ( SELECT COUNT(DISTINCT ta.NREGGEN) AS n FROM TRATAMIENT_ACTUAL ta JOIN PREVALENTES_ULT_DIA pu ON pu.NREGGEN = ta.NREGGEN WHERE ta.FECHAINI <= :FECHAFIN AND (ta.FECHAFIN IS NULL OR ta.FECHAFIN >= :FECHAFIN) AND UPPER(TRIM(ta.TRATAMIENTO)) IN (<LISTA_CAPTORES_NO_CALCICOS>) ) SELECT CAST(CASE WHEN d.n = 0 THEN 0 ELSE (n.n * 100.0) / d.n END AS NUMERIC(10,2)) AS resultado, d.n AS numero_pacientes, n.n AS numerador, d.n AS denominador FROM NUM n CROSS JOIN DENOM d;"
  },
  {
    "id_code": "2V68XWI0",
    "categoria": "Medicacion",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con hierro IV",
    "unidad": "%",
    "template": "WITH PREVALENTES_ULT_DIA AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND NOT EXISTS ( SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN) ) ), DENOM AS ( SELECT COUNT(DISTINCT NREGGEN) AS n FROM PREVALENTES_ULT_DIA ), NUM AS ( SELECT COUNT(DISTINCT th.NREGGEN) AS n FROM TRAT_HEMO th JOIN PREVALENTES_ULT_DIA pu ON pu.NREGGEN = th.NREGGEN WHERE th.FECHA_INI <= :FECHAFIN AND (th.FECHA_FIN IS NULL OR th.FECHA_FIN >= :FECHAFIN) AND UPPER(TRIM(th.VIA)) = 'IV' AND UPPER(TRIM(th.CODPRES)) IN (<LISTA_HIERRO_IV>) ) SELECT CAST(CASE WHEN d.n = 0 THEN 0 ELSE (n.n * 100.0) / d.n END AS NUMERIC(10,2)) AS resultado, d.n AS numero_pacientes, n.n AS numerador, d.n AS denominador FROM NUM n CROSS JOIN DENOM d;"
  },
  {
    "id_code": "2V69XWI0",
    "categoria": "Medicacion",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con hierro oral",
    "unidad": "%",
    "template": "WITH PREVALENTES_ULT_DIA AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND NOT EXISTS ( SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN) ) ), DENOM AS ( SELECT COUNT(DISTINCT NREGGEN) AS n FROM PREVALENTES_ULT_DIA ), NUM AS ( SELECT COUNT(DISTINCT ta.NREGGEN) AS n FROM TRATAMIENT_ACTUAL ta JOIN PREVALENTES_ULT_DIA pu ON pu.NREGGEN = ta.NREGGEN WHERE ta.FECHAINI <= :FECHAFIN AND (ta.FECHAFIN IS NULL OR ta.FECHAFIN >= :FECHAFIN) AND ta.GRUPO = 18 ) SELECT CAST(CASE WHEN d.n = 0 THEN 0 ELSE (n.n * 100.0) / d.n END AS NUMERIC(10,2)) AS resultado, d.n AS numero_pacientes, n.n AS numerador, d.n AS denominador FROM NUM n CROSS JOIN DENOM d;"
  },
  
  {
    "id_code": "2V70XWI0",
    "categoria": "Medicacion",
    "indicador": "Porcentaje de pacientes prevalentes ultimo dia de periodo en tratamiento con hierro IV y oral simultaneamente",
    "unidad": "%",
    "template": "WITH PREVALENTES_ULT_DIA AS ( SELECT DISTINCT p.NREGGEN FROM PACIENTES p JOIN SESION s ON s.NREGGEN = p.NREGGEN WHERE COALESCE(p.DESPLAZADO, 0) = 0 AND s.FECHA BETWEEN :FECHAINI AND :FECHAFIN AND NOT EXISTS ( SELECT 1 FROM INCIDENCIAS i JOIN CAUSAS_BAJA cb ON cb.CODCAUSA = i.CAUSABAJA AND cb.TIPO = 'B' WHERE i.NREGGEN = p.NREGGEN AND i.FECHAINI <= :FECHAFIN AND (i.FECHAFIN IS NULL OR i.FECHAFIN >= :FECHAFIN) ) ), DENOM AS ( SELECT COUNT(DISTINCT NREGGEN) AS n FROM PREVALENTES_ULT_DIA ), NUM AS ( SELECT COUNT(DISTINCT pu.NREGGEN) AS n FROM PREVALENTES_ULT_DIA pu WHERE EXISTS ( SELECT 1 FROM TRAT_HEMO th WHERE th.NREGGEN = pu.NREGGEN AND th.FECHA_INI <= :FECHAFIN AND (th.FECHA_FIN IS NULL OR th.FECHA_FIN >= :FECHAFIN) AND UPPER(TRIM(th.VIA)) = 'IV' AND UPPER(TRIM(th.CODPRES)) IN (<LISTA_HIERRO_IV>) ) AND EXISTS ( SELECT 1 FROM TRATAMIENT_ACTUAL ta WHERE ta.NREGGEN = pu.NREGGEN AND ta.FECHAINI <= :FECHAFIN AND (ta.FECHAFIN IS NULL OR ta.FECHAFIN >= :FECHAFIN) AND ta.GRUPO = 18 ) ) SELECT CAST(CASE WHEN d.n = 0 THEN 0 ELSE (n.n * 100.0) / d.n END AS NUMERIC(10,2)) AS resultado, d.n AS numero_pacientes, n.n AS numerador, d.n AS denominador FROM NUM n CROSS JOIN DENOM d;"
  },
  {
    "id_code": "6GPLJL8D",
    "categoria": "Medicacion ",
    "indicador": "Promedio unidades/ kg /semana de EPO",
    "unidad":"%",
    "template": "/* Promedio de UNIDADES/KG/SEMANA de EPO a FECHAFIN. REQUIERE: origen claro de dosis y peso. - Tabla de medicación vigente: TRATAMIENT_ACTUAL (EPO): columnas sugeridas DOSIS_SEMANAL_U (o derivar de pauta), FECHA. - Peso seco más reciente: última PAUTA (o tabla equivalente) <= FECHAFIN: campo PESOSECO. Ajuste nombres de tabla/campos según su modelo. */ WITH peso AS ( SELECT p.NREGGEN, FIRST 1 pa.PESOSECO FROM PACIENTES p JOIN PAUTA pa ON pa.NREGGEN = p.NREGGEN WHERE pa.FECHA <= FECHAFIN ORDER BY pa.NREGGEN, pa.FECHA DESC ), epo AS ( SELECT ta.NREGGEN, ta.DOSIS_SEMANAL_U FROM TRATAMIENT_ACTUAL ta JOIN PACIENTES p ON p.NREGGEN = ta.NREGGEN WHERE p.ESTADO='A' AND UPPER(ta.TRATAMIENTO) IN (<LISTA_EPO>) /* p.ej.: 'EPOETINA','DARBEPOETINA','MIRCERA' */ ), per_p AS ( SELECT e.NREGGEN, CASE WHEN pe.PESOSECO IS NULL OR pe.PESOSECO=0 THEN NULL ELSE (e.DOSIS_SEMANAL_U / pe.PESOSECO) END AS u_kg_semana FROM epo e LEFT JOIN peso pe ON pe.NREGGEN = e.NREGGEN ) SELECT AVG(u_kg_semana) AS promedio_u_kg_semana FROM per_p;"
  },
  {
    "id_code": "LEKXJYBF",
    "categoria": "Ocupación y Recursos",
    "indicador": "Tasa de ocupación de sillones",
    "unidad":"%",
    "template": "/* Tasa de ocupación de sillones en el periodo [FECHAINI, FECHAFIN]. Definición sugerida: (nº sesiones realizadas / capacidad teórica) * 100 REQUIERE: - SESION (o equivalente) con 1 fila por sesión realizada y fecha/hora. - CAPACIDAD: nº sillones * turnos por día * nº días en el periodo. Ajuste nombres y campos según su modelo. */ WITH sesiones AS ( SELECT COUNT(*) AS n_ses FROM SESION s WHERE s.FECHA BETWEEN FECHAINI AND FECHAFIN ), capacidad AS ( SELECT (COUNT(*) * :TURNOS_DIA * (DATEDIFF(DAY, FECHAINI, FECHAFIN) + 1)) AS cap FROM SILLON /* tabla con el inventario de sillones */ ) SELECT s.n_ses, c.cap, CASE WHEN c.cap=0 THEN 0 ELSE (s.n_ses*100.0)/c.cap END AS tasa_ocupacion_pct FROM sesiones s, capacidad c;"
  },
  {
    "id_code": "HUAAQGIP",
    "categoria": "Ocupación y Recursos",
    "indicador": "Turnos por sillón/día",
    "unidad":"%",
    "template": "/* Turnos por sillón y día en el periodo. Definición sugerida: (nº sesiones realizadas) / (nº sillones * nº días). */ WITH sesiones AS ( SELECT COUNT(*) AS n_ses FROM SESION s WHERE s.FECHA BETWEEN FECHAINI AND FECHAFIN ), sillones AS ( SELECT COUNT(*) AS n_sillones FROM SILLON ), ndias AS ( SELECT (DATEDIFF(DAY, FECHAINI, FECHAFIN) + 1) AS dias FROM RDB$DATABASE ) SELECT CASE WHEN sillones.n_sillones=0 OR ndias.dias=0 THEN 0 ELSE sesiones.n_ses * 1.0 / (sillones.n_sillones * ndias.dias) END AS turnos_por_sillon_dia FROM sesiones, sillones, ndias;"
  },
  {
    "id_code": "AJVL39WO",
    "categoria": "Ocupación y Recursos",
    "indicador": "Horas totales de funcionamiento",
    "unidad":"%",
    "template": "/* Horas totales de funcionamiento (suma de horas de sesiones) en el periodo. */ SELECT SUM(EXTRACT(HOUR FROM (s.HFIN - s.HINI)) + EXTRACT(MINUTE FROM (s.HFIN - s.HINI))/60.0) AS horas_totales FROM SESION s WHERE s.FECHA BETWEEN FECHAINI AND FECHAFIN;"
  },
  {
    "id_code": "4S9CL7CI",
    "categoria": "Calidad Técnica",
    "indicador": "% sesiones sin incidentes técnicos",
    "unidad":"%",
    "template": "/* % de sesiones SIN incidentes técnicos en el periodo. REQUIERE: regla de vínculo SESION ↔ INCIDENCIAS (p.ej., por NREGGEN y fecha o ID de sesión si existe). Aquí se asume que la tabla de incidencias tiene TIPO='T' (técnica). Ajuste según catálogo real. */ WITH tot AS ( SELECT COUNT(*) AS n_tot FROM SESION s WHERE s.FECHA BETWEEN FECHAINI AND FECHAFIN ), con_inc AS ( SELECT COUNT(DISTINCT s.IDSESION) AS n_con_inc FROM SESION s JOIN INCIDENCIAS i ON i.NREGGEN = s.NREGGEN AND i.FECHAINI BETWEEN s.FECHA AND s.FECHA /* Ajuste la condición y TIPO según su modelo */ AND UPPER(i.TIPO) = 'TECNICA' WHERE s.FECHA BETWEEN FECHAINI AND FECHAFIN ) SELECT (tot.n_tot - con_inc.n_con_inc) AS sesiones_sin_inc, tot.n_tot AS sesiones_totales, CASE WHEN tot.n_tot=0 THEN 0 ELSE ((tot.n_tot - con_inc.n_con_inc)*100.0)/tot.n_tot END AS pct_sin_inc FROM tot, con_inc;"
  },
  {
    "id_code": "SSKURCNF",
    "categoria": "Calidad técnica - infecciones",
    "indicador": "Tasa de infecciones por catéter",
    "unidad":"%",
    "template": "SELECT COUNT(*) AS resultado, COUNT(*) AS numero_pacientes FROM INCIDENCIAS i WHERE i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND (UPPER(i.TIPO) = 'INFECCION CATETER' OR UPPER(i.COMENTARIOCEN) LIKE '%CATETER%');"
  },
  {
    "id_code": "FI1024A1",
    "categoria": "Calidad técnica - diálisis adecuada",
    "indicador": "% pacientes activos con Kt/V ≥ 1.2 (última analítica en periodo)",
    "unidad":"%",
    "template": "WITH ult AS (SELECT a.NREGGEN, MAX(a.FECHA) AS FECHA_ULT FROM ANALISIS a JOIN PACIENTES p ON p.NREGGEN = a.NREGGEN WHERE a.FECHA BETWEEN :FECHAINI AND :FECHAFIN GROUP BY a.NREGGEN), ktv AS (SELECT a.NREGGEN, r.VALOR FROM ANALISIS a JOIN ult u ON u.NREGGEN = a.NREGGEN AND u.FECHA_ULT = a.FECHA JOIN RESULANAL r ON r.ANALISIS = a.NUMANALISIS WHERE UPPER(r.CODANAL) IN ('KTV','KT/V','KTVE')) SELECT COUNT(CASE WHEN CAST(k.VALOR AS DECIMAL(9,3)) >= 1.2 THEN 1 END) AS resultado, COUNT(*) AS numero_pacientes FROM ktv k;"
  },
  {
    "id_code": "1XSOY0QR",
    "categoria": "Resultados en Salud",
    "indicador": "% pacientes en lista de espera",
    "unidad":"%",
    "template": "/* % de pacientes activos en LISTA DE ESPERA (p. ej., trasplante). Se usa PACIENTES.LISESPTRAS. */ WITH denom AS ( /* Denominador común: pacientes activos prevalentes a FECHAFIN */ SELECT COUNT(*) AS total_activos FROM PACIENTES p WHERE p.ESTADO = 'A' /* Si procede acotar a hemodiálisis (descomentar si el campo lo permite) AND p.MODAL_TRAT = 'H' */ ), num AS ( SELECT COUNT(*) AS n FROM PACIENTES p WHERE p.ESTADO='A' AND ( p.LISESPTRAS IS NOT NULL AND (p.LISESPTRAS = 1 OR UPPER(CAST(p.LISESPTRAS AS VARCHAR(10))) IN ('S','SI','SÍ','YES')) ) ) SELECT num.n AS numerador, denom.total_activos AS denominador, CASE WHEN denom.total_activos=0 THEN 0 ELSE (num.n*100.0)/denom.total_activos END AS porcentaje FROM num, denom;"
  },
  {
    "id_code": "QK9HXS35",
    "categoria": "Resultados en Salud",
    "indicador": "% con parámetros bioquímicos en rango (P, K, Hb…)",
    "unidad":"",
    "template": "/* % de pacientes activos cuya ÚLTIMA analítica en el periodo está EN RANGO para P, K, Hb. Rangos parametrizables; ajuste según su protocolo. - Fósforo (CODANAL IN ('FOSFORO','P')) entre :P_MIN y :P_MAX - Potasio (CODANAL IN ('POTASIO','K')) entre :K_MIN y :K_MAX - Hemoglobina (CODANAL = 'HEMOG') entre :HB_MIN y :HB_MAX */ WITH ult AS ( SELECT a.NREGGEN, MAX(a.FECHA) AS FECHA_ULT FROM ANALISIS a JOIN PACIENTES p ON p.NREGGEN = a.NREGGEN WHERE p.ESTADO='A' AND a.FECHA BETWEEN FECHAINI AND FECHAFIN GROUP BY a.NREGGEN ), vals AS ( SELECT a.NREGGEN, MAX(CASE WHEN UPPER(r.CODANAL) IN ('FOSFORO','P') THEN r.VALOR END) AS P, MAX(CASE WHEN UPPER(r.CODANAL) IN ('POTASIO','K') THEN r.VALOR END) AS K, MAX(CASE WHEN UPPER(r.CODANAL) = 'HEMOG' THEN r.VALOR END) AS HB FROM ANALISIS a JOIN ult u ON u.NREGGEN=a.NREGGEN AND u.FECHA_ULT=a.FECHA JOIN RESULANAL r ON r.ANALISIS=a.NUMANALISIS GROUP BY a.NREGGEN ), ok AS ( SELECT COUNT(*) AS n_ok FROM vals WHERE CAST(P AS DECIMAL(9,3)) BETWEEN :P_MIN AND :P_MAX AND CAST(K AS DECIMAL(9,3)) BETWEEN :K_MIN AND :K_MAX AND CAST(HB AS DECIMAL(9,3)) BETWEEN :HB_MIN AND :HB_MAX ), denom AS ( /* Denominador común: pacientes activos prevalentes a FECHAFIN */ SELECT COUNT(*) AS total_activos FROM PACIENTES p WHERE p.ESTADO = 'A' /* Si procede acotar a hemodiálisis (descomentar si el campo lo permite) AND p.MODAL_TRAT = 'H' */ ) SELECT ok.n_ok AS numerador, denom.total_activos AS denominador, CASE WHEN denom.total_activos=0 THEN 0 ELSE (ok.n_ok*100.0)/denom.total_activos END AS porcentaje FROM ok, denom;"
  },
  {
    "id_code": "QEV1TJDE",
    "categoria": "Experiencia del Paciente",
    "indicador": "Índice de satisfacción",
    "unidad":"",
    "template": "/* Índice de satisfacción (0-10). Promedio de la puntuación de ENCUESTA en el periodo. */ SELECT AVG(CAST(e.PUNTUACION AS DECIMAL(9,3))) AS indice_satisfaccion FROM ENCUESTA_SATISFACCION e WHERE e.FECHA BETWEEN FECHAINI AND FECHAFIN AND e.PUNTUACION IS NOT NULL;"
  },
  {
    "id_code": "UHC1I99H",
    "categoria": "Experiencia del Paciente",
    "indicador": "",
    "unidad":"Quejas o sugerencias",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM INCIDENCIAS i JOIN PACIENTES p ON p.NREGGEN = i.NREGGEN WHERE i.FECHAINI BETWEEN :FECHAINI AND :FECHAFIN AND UPPER(i.TIPO) IN ('QUEJA', 'SUGERENCIA'); -- <- AJUSTA;"
  },
  {
    "id_code": "I9E5QQIF",
    "categoria": "Eficiencia y Gestión",
    "indicador": "Coste medio por sesión",
    "unidad":"€/sesión",
    "template": "-- Coste medio por sesión (todas). Hay que enviar parametro ---- > coste total WITH SES_FILTRADAS AS ( SELECT s.NSESION FROM SESION s JOIN PACIENTES p ON p.NREGGEN = s.NREGGEN WHERE s.FECHA BETWEEN :FECHAINI AND :FECHAFIN ) SELECT COUNT(*) AS TOTAL_SESIONES, :COSTE_TOTAL / NULLIF(COUNT(*), 0) AS COSTE_MEDIO_POR_SESION FROM SES_FILTRADAS;"
  },
  {
    "id_code": "P90QTWMJ",
    "categoria": "Eficiencia y Gestión",
    "indicador": "Ratio paciente/enfermera",
    "unidad":"Ratio",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p JOIN PERSONAL pers ON p.ENFERMERA = pers.CODIGO WHERE pers.COD_ROL = (SELECT COD_ROL FROM ROL WHERE NOMBRE LIKE '%ENFERMERA%');"
  },
  {
    "id_code": "MLYUG37Y",
    "categoria": "Eficiencia y Gestión",
    "indicador": "Ratio paciente/auxiliares",
    "unidad":"Ratio",
    "template": "SELECT COUNT(*) AS resultado, COUNT(DISTINCT p.NREGGEN) AS numero_pacientes FROM PACIENTES p CROSS JOIN PERSONAL per WHERE p.FECH_INICIO_CENTRO <= :FECHAFIN AND per.COD_ROL = <CODIGO_AUXILIAR>;"
  }
]